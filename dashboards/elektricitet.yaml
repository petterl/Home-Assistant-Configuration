title: Electricitet
views:
  - title: Översikt
    path: oversikt
    icon: mdi:flash
    cards:
      # Current electricity price
      - type: entities
        title: Aktuella Priser
        entities:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris (Nord Pool SE3)
          - entity: sensor.elpris_skelleftea_kraft
            name: Totalpris (inkl. påslag)
          - entity: sensor.ersattning_solproduktion
            name: Ersättning solproduktion

      # Effekttariff section
      - type: entities
        title: Effekttariff
        entities:
          - entity: sensor.peak_power_top_5_average
            name: Topp 5 medel (kW)
          - entity: sensor.effektavgift_manad
            name: Effektavgift denna månad

      # Current power usage
      - type: gauge
        entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
        name: Aktuell Effekt
        unit: W
        min: 0
        max: 10000
        severity:
          green: 0
          yellow: 3000
          red: 6000

      # Electricity price chart - Today & Tomorrow
      - type: custom:apexcharts-card
        header:
          show: true
          title: Elpris Idag & Imorgon
        graph_span: 48h
        span:
          start: day
        now:
          show: true
          label: Nu
        yaxis:
          - id: price
            min: 0
        series:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
            type: column
            yaxis_id: price
            data_generator: |
              const attr = entity.attributes || {};
              const today = attr.raw_today ?? [];
              const tomorrow = attr.raw_tomorrow ?? [];
              const all = [...today, ...tomorrow];
              return all.map((d) => {
                const ts = new Date(d.start).getTime();
                return [ts, d.value];
              });
            color: rgb(33, 150, 243)

      # Power consumption over time
      - type: history-graph
        title: Effekt (24h)
        entities:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Effekt
        hours_to_show: 24

  - title: Energi
    path: energi
    icon: mdi:lightning-bolt
    cards:
      # Energy import/export today
      - type: entities
        title: Energi Idag
        entities:
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_forbrukad
            name: Förbrukat från nät
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_producerad
            name: Exporterat till nät

      # Solar production
      - type: entities
        title: Solproduktion
        entities:
          - entity: sensor.solarnet_effekt_solceller
            name: Aktuell produktion
          - entity: sensor.fornvagen_19_linkoping_total_energi
            name: Total produktion (Wh)
          - entity: sensor.fornvagen_19_linkoping_inverterlage
            name: Inverter status

      # Real-time power flow
      - type: entities
        title: Effektflöde (realtid)
        entities:
          - entity: sensor.solarnet_elnat_import
            name: Import från nät
          - entity: sensor.solarnet_elnat_export
            name: Export till nät
          - entity: sensor.solarnet_forbrukad_effekt
            name: Total förbrukning
          - entity: sensor.solarnet_relativ_autonomi
            name: Självförsörjningsgrad

      # Energy flow diagram (if you have the energy-flow-card)
      - type: energy-distribution
        link_dashboard: true

  - title: Effekttariff
    path: effekttariff
    icon: mdi:chart-timeline-variant
    type: custom:grid-layout
    cards:
      # Current month summary
      - type: entities
        title: Effekttariff - Aktuell Månad
        entities:
          - entity: sensor.peak_power_top_5_average
            name: Topp 5 medel
          - entity: sensor.effektavgift_manad
            name: Beräknad månadsavgift

      # Top 5 peaks detail card
      - type: markdown
        title: Topp 5 Effekttoppar
        content: |
          | # | Tidpunkt | Effekt |
          |---|----------|--------|
          | 1 | {{ states('sensor.peak_power_1_time') | as_timestamp | timestamp_custom('%d %b %H:00') if states('sensor.peak_power_1_time') not in ['unknown', 'unavailable'] else '-' }} | {{ (states('sensor.peak_power_1_value') | float / 1000) | round(2) }} kW |
          | 2 | {{ states('sensor.peak_power_2_time') | as_timestamp | timestamp_custom('%d %b %H:00') if states('sensor.peak_power_2_time') not in ['unknown', 'unavailable'] else '-' }} | {{ (states('sensor.peak_power_2_value') | float / 1000) | round(2) }} kW |
          | 3 | {{ states('sensor.peak_power_3_time') | as_timestamp | timestamp_custom('%d %b %H:00') if states('sensor.peak_power_3_time') not in ['unknown', 'unavailable'] else '-' }} | {{ (states('sensor.peak_power_3_value') | float / 1000) | round(2) }} kW |
          | 4 | {{ states('sensor.peak_power_4_time') | as_timestamp | timestamp_custom('%d %b %H:00') if states('sensor.peak_power_4_time') not in ['unknown', 'unavailable'] else '-' }} | {{ (states('sensor.peak_power_4_value') | float / 1000) | round(2) }} kW |
          | 5 | {{ states('sensor.peak_power_5_time') | as_timestamp | timestamp_custom('%d %b %H:00') if states('sensor.peak_power_5_time') not in ['unknown', 'unavailable'] else '-' }} | {{ (states('sensor.peak_power_5_value') | float / 1000) | round(2) }} kW |

      # Monthly power chart with hourly average (matching effekttariff calculation)
      - type: custom:apexcharts-card
        view_layout:
          grid-column: span 2
        header:
          show: true
          title: Effekt denna månad (timmedel)
        graph_span: 31d
        span:
          start: month
        apex_config:
          chart:
            height: 450
        series:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Timmedel
            type: line
            color: "#2196F3"
            stroke_width: 1
            group_by:
              func: avg
              duration: 1h
          - entity: sensor.peak_power_1_time
            name: Topp 1
            type: line
            color: "#FF5722"
            stroke_width: 2
            opacity: 0.7
            show:
              in_header: false
              legend_value: false
            data_generator: |
              const t = hass.states['sensor.peak_power_1_time'];
              const v = hass.states['sensor.peak_power_1_value'];
              if (!t || t.state === 'unknown' || !v) return [];
              const ts = new Date(t.state).getTime();
              const val = parseFloat(v.state);
              return [[ts, 0], [ts, val]];
          - entity: sensor.peak_power_2_time
            name: Topp 2
            type: line
            color: "#FF5722"
            stroke_width: 2
            opacity: 0.7
            show:
              in_header: false
              legend_value: false
            data_generator: |
              const t = hass.states['sensor.peak_power_2_time'];
              const v = hass.states['sensor.peak_power_2_value'];
              if (!t || t.state === 'unknown' || !v) return [];
              const ts = new Date(t.state).getTime();
              const val = parseFloat(v.state);
              return [[ts, 0], [ts, val]];
          - entity: sensor.peak_power_3_time
            name: Topp 3
            type: line
            color: "#FF5722"
            stroke_width: 2
            opacity: 0.7
            show:
              in_header: false
              legend_value: false
            data_generator: |
              const t = hass.states['sensor.peak_power_3_time'];
              const v = hass.states['sensor.peak_power_3_value'];
              if (!t || t.state === 'unknown' || !v) return [];
              const ts = new Date(t.state).getTime();
              const val = parseFloat(v.state);
              return [[ts, 0], [ts, val]];
          - entity: sensor.peak_power_4_time
            name: Topp 4
            type: line
            color: "#FF5722"
            stroke_width: 2
            opacity: 0.7
            show:
              in_header: false
              legend_value: false
            data_generator: |
              const t = hass.states['sensor.peak_power_4_time'];
              const v = hass.states['sensor.peak_power_4_value'];
              if (!t || t.state === 'unknown' || !v) return [];
              const ts = new Date(t.state).getTime();
              const val = parseFloat(v.state);
              return [[ts, 0], [ts, val]];
          - entity: sensor.peak_power_5_time
            name: Topp 5
            type: line
            color: "#FF5722"
            stroke_width: 2
            opacity: 0.7
            show:
              in_header: false
              legend_value: false
            data_generator: |
              const t = hass.states['sensor.peak_power_5_time'];
              const v = hass.states['sensor.peak_power_5_value'];
              if (!t || t.state === 'unknown' || !v) return [];
              const ts = new Date(t.state).getTime();
              const val = parseFloat(v.state);
              return [[ts, 0], [ts, val]];

      # Info card explaining the calculation
      - type: markdown
        title: Om Effekttariff
        content: |
          **Så beräknas effektavgiften:**

          1. Varje timmes högsta effekt (W) registreras
          2. De 5 högsta timmedelvärdena under månaden väljs ut
          3. Medelvärdet av dessa 5 toppar beräknas
          4. Avgiften = medelvärde × tariff

          **Tariffer:**
          - Sommar (apr-okt): **22 kr/kW**
          - Vinter (nov-mar): **43 kr/kW**

          **Tips för att sänka effektavgiften:**
          - Undvik att köra flera stora förbrukare samtidigt
          - Fördela tvätt, disk, laddning över tid
          - Använd timer för att sprida last

  - title: Statistik
    path: statistik
    icon: mdi:chart-line
    cards:
      # Monthly energy statistics
      - type: history-graph
        title: Energiförbrukning (7 dagar)
        entities:
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_forbrukad
            name: Förbrukat
        hours_to_show: 168

      # Price statistics
      - type: history-graph
        title: Elpris (7 dagar)
        entities:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
        hours_to_show: 168

      # Peak power tracking
      - type: history-graph
        title: Effekttoppar (7 dagar)
        entities:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Effekt
        hours_to_show: 168

  - title: Kostnader
    path: kostnader
    icon: mdi:currency-usd
    cards:
      # Current costs overview
      - type: markdown
        title: Kostnadssammanställning
        content: |
          ## Aktuella priser

          | Typ | Pris |
          |-----|------|
          | Spotpris | {{ states('sensor.nordpool_kwh_se3_sek_3_10_025') }} SEK/kWh |
          | Totalpris | {{ states('sensor.elpris_skelleftea_kraft') }} SEK/kWh |
          | Solersättning | {{ states('sensor.ersattning_solproduktion') }} SEK/kWh |

          ## Effekttariff

          | Mått | Värde |
          |------|-------|
          | Topp 5 medel | {{ states('sensor.peak_power_top_5_average') }} kW |
          | Månadsavgift | {{ states('sensor.effektavgift_manad') }} SEK |

          ---
          *Säsong: {{ 'Sommar (22 kr/kW)' if now().month >= 4 and now().month <= 10 else 'Vinter (43 kr/kW)' }}*

      # Price comparison chart
      - type: custom:apexcharts-card
        header:
          show: true
          title: Priskomponenter
        chart_type: donut
        series:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
            color: rgb(33, 150, 243)
          - entity: sensor.elpris_skelleftea_kraft
            name: Påslag
            color: rgb(76, 175, 80)
            transform: "return x - parseFloat(hass.states['sensor.nordpool_kwh_se3_sek_3_10_025'].state);"
