title: Elektricitet
views:
  - title: Översikt
    path: oversikt
    icon: mdi:flash
    type: custom:grid-layout
    layout:
      grid-template-columns: 1fr 2fr
      grid-template-rows: auto
      grid-template-areas: |
        "status status"
        "metrics metrics"
        "left price"
        "left power"
    cards:
      # Price status hero card - full width
      - type: markdown
        view_layout:
          grid-area: status
        content: |
          {% set price = states('sensor.nordpool_kwh_se3_sek_3_10_025') | float %}
          {% set avg = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'average') | float %}
          {% set min_price = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'min') | float %}
          {% set max_price = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'max') | float %}
          {% set diff = ((price - avg) / avg * 100) | round(0) %}
          {% if price <= min_price * 1.1 %}
          <ha-alert alert-type="success">LÄGSTA PRIS — Kör tunga förbrukare nu!</ha-alert>
          {% elif price < avg * 0.8 %}
          <ha-alert alert-type="success">Lågt pris — Bra tid att använda el</ha-alert>
          {% elif price < avg * 1.2 %}
          <ha-alert alert-type="info">Normalt pris</ha-alert>
          {% elif price >= max_price * 0.9 %}
          <ha-alert alert-type="error">HÖGSTA PRIS — Undvik förbrukning!</ha-alert>
          {% else %}
          <ha-alert alert-type="warning">Högt pris — Skjut upp om möjligt</ha-alert>
          {% endif %}
        card_mod:
          style: |
            ha-card {
              background: none;
              box-shadow: none;
              padding: 0;
            }

      # Key metrics row - full width
      - type: horizontal-stack
        view_layout:
          grid-area: metrics
        cards:
          - type: custom:mushroom-entity-card
            entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Elpris
            icon: mdi:currency-usd
            icon_color: amber
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-amber), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Effekt
            icon: mdi:flash
            icon_color: blue
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-blue), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.solarnet_effekt_solceller
            name: Sol
            icon: mdi:solar-power
            icon_color: orange
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-orange), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.solarnet_relativ_autonomi
            name: Självförsörjning
            icon: mdi:home-battery
            icon_color: green
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-green), 0.1);
                }

      # Left column - Gauge and info stacked
      - type: vertical-stack
        view_layout:
          grid-area: left
        cards:
          - type: gauge
            entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Aktuell Effekt
            unit: W
            min: 0
            max: 10000
            needle: true
            segments:
              - from: 0
                color: "#4caf50"
              - from: 3000
                color: "#ff9800"
              - from: 6000
                color: "#f44336"
            card_mod:
              style: |
                ha-card {
                  --ha-card-border-radius: 16px;
                }
          - type: entities
            title: Dagens Priser
            entities:
              - entity: sensor.elpris_lagsta_idag
                name: Lägsta
              - entity: sensor.elpris_hogsta_idag
                name: Högsta
              - entity: sensor.elpris_medel_idag
                name: Medel
          - type: entities
            title: Billigaste Timmarna
            entities:
              - type: attribute
                entity: sensor.billigaste_timpriser
                attribute: hour_1
                name: "#1"
                icon: mdi:numeric-1-circle
              - type: attribute
                entity: sensor.billigaste_timpriser
                attribute: hour_2
                name: "#2"
                icon: mdi:numeric-2-circle
              - type: attribute
                entity: sensor.billigaste_timpriser
                attribute: hour_3
                name: "#3"
                icon: mdi:numeric-3-circle
              - type: attribute
                entity: sensor.billigaste_timpriser
                attribute: hour_4
                name: "#4"
                icon: mdi:numeric-4-circle
              - type: attribute
                entity: sensor.billigaste_timpriser
                attribute: hour_5
                name: "#5"
                icon: mdi:numeric-5-circle

      # Right column - Price chart (spans 2 columns)
      - type: custom:apexcharts-card
        view_layout:
          grid-area: price
        header:
          show: true
          title: Elpris Idag & Imorgon
          show_states: false
        graph_span: 48h
        span:
          start: day
        now:
          show: true
          label: Nu
        yaxis:
          - min: 0
            apex_config:
              labels:
                formatter: |
                  EVAL:function(val) { return val.toFixed(1) + ' kr'; }
        apex_config:
          chart:
            height: 350
          legend:
            show: false
          tooltip:
            y:
              formatter: |
                EVAL:function(val) { return val ? val.toFixed(2) + ' kr/kWh' : '-'; }
        series:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Lågt
            type: column
            color: "#4caf50"
            show:
              legend_value: false
            data_generator: |
              var t = entity.attributes.today || [];
              var m = entity.attributes.tomorrow || [];
              var s = new Date(); s.setHours(0,0,0,0);
              var base = s.getTime();
              var r = [];
              for (var i=0; i<t.length; i++) r.push([base + i*900000, t[i] < 0.8 ? t[i] : null]);
              for (var i=0; i<m.length; i++) r.push([base + 86400000 + i*900000, m[i] < 0.8 ? m[i] : null]);
              return r;
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Medel
            type: column
            color: "#8bc34a"
            show:
              legend_value: false
            data_generator: |
              var t = entity.attributes.today || [];
              var m = entity.attributes.tomorrow || [];
              var s = new Date(); s.setHours(0,0,0,0);
              var base = s.getTime();
              var r = [];
              for (var i=0; i<t.length; i++) r.push([base + i*900000, (t[i] >= 0.8 && t[i] < 1.2) ? t[i] : null]);
              for (var i=0; i<m.length; i++) r.push([base + 86400000 + i*900000, (m[i] >= 0.8 && m[i] < 1.2) ? m[i] : null]);
              return r;
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Högt
            type: column
            color: "#ff9800"
            show:
              legend_value: false
            data_generator: |
              var t = entity.attributes.today || [];
              var m = entity.attributes.tomorrow || [];
              var s = new Date(); s.setHours(0,0,0,0);
              var base = s.getTime();
              var r = [];
              for (var i=0; i<t.length; i++) r.push([base + i*900000, (t[i] >= 1.2 && t[i] < 1.8) ? t[i] : null]);
              for (var i=0; i<m.length; i++) r.push([base + 86400000 + i*900000, (m[i] >= 1.2 && m[i] < 1.8) ? m[i] : null]);
              return r;
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Mycket högt
            type: column
            color: "#f44336"
            show:
              legend_value: false
            data_generator: |
              var t = entity.attributes.today || [];
              var m = entity.attributes.tomorrow || [];
              var s = new Date(); s.setHours(0,0,0,0);
              var base = s.getTime();
              var r = [];
              for (var i=0; i<t.length; i++) r.push([base + i*900000, t[i] >= 1.8 ? t[i] : null]);
              for (var i=0; i<m.length; i++) r.push([base + 86400000 + i*900000, m[i] >= 1.8 ? m[i] : null]);
              return r;

      # Power flow chart - right column below price
      - type: custom:apexcharts-card
        view_layout:
          grid-area: power
        header:
          show: true
          title: Effekt & Sol (24h)
        graph_span: 24h
        apex_config:
          chart:
            height: 300
          legend:
            position: top
          stroke:
            width: 2
        series:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Förbrukning
            type: area
            color: "#2196f3"
            opacity: 0.2
            group_by:
              func: avg
              duration: 10m
          - entity: sensor.solarnet_effekt_solceller
            name: Solproduktion
            type: area
            color: "#ff9800"
            opacity: 0.2
            group_by:
              func: avg
              duration: 10m

  - title: Energi
    path: energi
    icon: mdi:lightning-bolt
    type: custom:grid-layout
    layout:
      grid-template-columns: 1fr 1fr 1fr
      grid-template-rows: auto
      grid-template-areas: |
        "metrics metrics metrics"
        "gauge chart chart"
        "info chart chart"
        "solar phases phases"
    cards:
      # Key metrics - full width
      - type: horizontal-stack
        view_layout:
          grid-area: metrics
        cards:
          - type: custom:mushroom-entity-card
            entity: sensor.solarnet_effekt_solceller
            name: Produktion
            icon: mdi:solar-power
            icon_color: orange
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-orange), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.solarnet_relativ_autonomi
            name: Autonomi
            icon: mdi:home-battery
            icon_color: green
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-green), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.solarnet_relativ_sjalvkonsumtion
            name: Självkonsumtion
            icon: mdi:home-circle
            icon_color: teal
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-teal), 0.1);
                }

      # Left - Gauge
      - type: gauge
        view_layout:
          grid-area: gauge
        entity: sensor.solarnet_relativ_autonomi
        name: Självförsörjning
        unit: "%"
        min: 0
        max: 100
        needle: true
        segments:
          - from: 0
            color: "#f44336"
          - from: 25
            color: "#ff9800"
          - from: 50
            color: "#8bc34a"
          - from: 75
            color: "#4caf50"
        card_mod:
          style: |
            ha-card {
              --ha-card-border-radius: 16px;
            }

      # Left - Grid energy info
      - type: entities
        view_layout:
          grid-area: info
        title: Nätenergi
        show_header_toggle: false
        entities:
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_forbrukad
            name: Importerat från nät
            icon: mdi:transmission-tower-import
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_producerad
            name: Exporterat till nät
            icon: mdi:transmission-tower-export
          - entity: sensor.solarnet_total_energi
            name: Total solenergi
            icon: mdi:solar-power

      # Right - Energy flow chart (spans 2 columns, 2 rows)
      - type: custom:apexcharts-card
        view_layout:
          grid-area: chart
        header:
          show: true
          title: Energiflöde (24h)
        graph_span: 24h
        apex_config:
          chart:
            height: 350
          legend:
            position: top
          stroke:
            width: 2
        series:
          - entity: sensor.solarnet_effekt_solceller
            name: Solproduktion
            type: area
            color: "#ff9800"
            opacity: 0.5
            group_by:
              func: avg
              duration: 15m
          - entity: sensor.solarnet_forbrukad_effekt
            name: Förbrukning
            type: line
            color: "#2196f3"
            group_by:
              func: avg
              duration: 15m
          - entity: sensor.solarnet_elnat_import
            name: Import
            type: area
            color: "#f44336"
            opacity: 0.3
            group_by:
              func: avg
              duration: 15m
          - entity: sensor.solarnet_elnat_export
            name: Export
            type: area
            color: "#4caf50"
            opacity: 0.3
            group_by:
              func: avg
              duration: 15m

      # Bottom left - Solar system
      - type: entities
        view_layout:
          grid-area: solar
        title: Solceller
        show_header_toggle: false
        entities:
          - entity: sensor.solarnet_effekt_solceller
            name: Aktuell produktion
            icon: mdi:solar-power
          - entity: sensor.fornvagen_19_linkoping_total_energi
            name: Total produktion
            icon: mdi:counter
          - entity: sensor.fornvagen_19_linkoping_inverterlage
            name: Inverter status
            icon: mdi:information-outline

      # Bottom right - Phase info (spans 2 columns)
      - type: entities
        view_layout:
          grid-area: phases
        title: Fasinformation
        show_header_toggle: false
        entities:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt_fas_1
            name: Fas 1
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt_fas_2
            name: Fas 2
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt_fas_3
            name: Fas 3

  - title: Effekttariff
    path: effekttariff
    icon: mdi:chart-timeline-variant
    type: custom:grid-layout
    layout:
      grid-template-columns: 1fr 1fr 1fr
      grid-template-rows: auto
      grid-template-areas: |
        "status status status"
        "metrics metrics metrics"
        "peaks chart chart"
        "tips chart chart"
    cards:
      # Status - full width
      - type: markdown
        view_layout:
          grid-area: status
        content: |
          {% set month = now().month %}
          {% if month >= 4 and month <= 10 %}
          <ha-alert alert-type="success">
          <strong>Sommartariff aktiv</strong> — 22 kr/kW (April–Oktober)
          </ha-alert>
          {% else %}
          <ha-alert alert-type="warning">
          <strong>Vintertariff aktiv</strong> — 43 kr/kW (November–Mars)
          </ha-alert>
          {% endif %}
        card_mod:
          style: |
            ha-card {
              background: none;
              box-shadow: none;
              padding: 0;
            }

      # Key metrics - full width
      - type: horizontal-stack
        view_layout:
          grid-area: metrics
        cards:
          - type: custom:mushroom-entity-card
            entity: sensor.peak_power_top_5_average
            name: Topp 5 medel
            icon: mdi:chart-bell-curve
            icon_color: blue
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-blue), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.effektavgift_manad
            name: Månadsavgift
            icon: mdi:cash
            icon_color: amber
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-amber), 0.1);
                }

      # Left - Top 5 peaks
      - type: entities
        view_layout:
          grid-area: peaks
        title: Topp 5 Effekttoppar
        entities:
          - entity: sensor.effekttopp_1
            name: "1. Högsta"
          - entity: sensor.effekttopp_2
            name: "2."
          - entity: sensor.effekttopp_3
            name: "3."
          - entity: sensor.effekttopp_4
            name: "4."
          - entity: sensor.effekttopp_5
            name: "5."

      # Left - Tips
      - type: markdown
        view_layout:
          grid-area: tips
        title: Tips
        content: |
          **Så håller du nere effektavgiften:**

          &#128161; Undvik flera stora förbrukare samtidigt

          &#128161; Fördela tvätt, disk och laddning över tid

          &#128161; Var extra försiktig vintertid (dubbel tariff!)

      # Right - Monthly chart (spans 2 columns, 2 rows)
      - type: custom:apexcharts-card
        view_layout:
          grid-area: chart
        header:
          show: true
          title: Effekt denna månad
        graph_span: 31d
        span:
          start: month
        apex_config:
          chart:
            height: 350
          stroke:
            width: 2
          annotations:
            yaxis:
              - y: 2660
                borderColor: "#4caf50"
                borderWidth: 2
                strokeDashArray: 5
                label:
                  text: "Topp 5"
                  style:
                    background: "#4caf50"
                    color: "#fff"
        series:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Timmedel
            type: line
            color: "#2196f3"
            group_by:
              func: avg
              duration: 1h

  - title: Förbrukare
    path: forbrukare
    icon: mdi:devices
    type: custom:grid-layout
    layout:
      grid-template-columns: 1fr 1fr 1fr
      grid-template-rows: auto
      grid-template-areas: |
        "metrics metrics metrics"
        "energy chart chart"
        "energy chart chart"
    cards:
      # Device power cards - full width
      - type: horizontal-stack
        view_layout:
          grid-area: metrics
        cards:
          - type: custom:mushroom-entity-card
            entity: sensor.ftx_power
            name: FTX
            icon: mdi:fan
            icon_color: blue
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-blue), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.casa_power
            name: CASA
            icon: mdi:air-filter
            icon_color: cyan
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-cyan), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.frys_power
            name: Frys
            icon: mdi:fridge
            icon_color: light-blue
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-light-blue), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.ida_smartplug_power
            name: Ida
            icon: mdi:power-socket-eu
            icon_color: purple
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-purple), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.torktumlare_effekt
            name: Torktumlare
            icon: mdi:tumble-dryer
            icon_color: orange
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-orange), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.okand_effekt
            name: Okänd
            icon: mdi:help-circle
            icon_color: grey
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-grey), 0.1);
                }

      # Left - Energy totals
      - type: entities
        view_layout:
          grid-area: energy
        title: Energi (24h)
        show_header_toggle: false
        entities:
          - entity: sensor.ftx_energi_24h
            name: FTX (Ventilation)
            icon: mdi:fan
          - entity: sensor.casa_energi_24h
            name: CASA
            icon: mdi:air-filter
          - entity: sensor.frys_energi_24h
            name: Frys
            icon: mdi:fridge
          - entity: sensor.ida_energi_24h
            name: Ida Smartplug
            icon: mdi:power-socket-eu
          - entity: sensor.torktumlare_energi_24h
            name: Torktumlare
            icon: mdi:tumble-dryer
          - entity: sensor.okand_energi_24h
            name: Okänd
            icon: mdi:help-circle

      # Right - Device chart (spans 2 columns)
      - type: custom:apexcharts-card
        view_layout:
          grid-area: chart
        header:
          show: true
          title: Förbrukare (24h)
        graph_span: 24h
        apex_config:
          chart:
            height: 350
          legend:
            position: top
          stroke:
            width: 2
        series:
          - entity: sensor.ftx_power
            name: FTX
            type: area
            color: "#2196f3"
            opacity: 0.5
            group_by:
              func: avg
              duration: 15m
          - entity: sensor.casa_power
            name: CASA
            type: area
            color: "#00bcd4"
            opacity: 0.5
            group_by:
              func: avg
              duration: 15m
          - entity: sensor.frys_power
            name: Frys
            type: area
            color: "#03a9f4"
            opacity: 0.5
            group_by:
              func: avg
              duration: 15m
          - entity: sensor.ida_smartplug_power
            name: Ida
            type: area
            color: "#9c27b0"
            opacity: 0.5
            group_by:
              func: avg
              duration: 15m
          - entity: sensor.torktumlare_effekt
            name: Torktumlare
            type: area
            color: "#ff9800"
            opacity: 0.5
            group_by:
              func: avg
              duration: 15m
          - entity: sensor.okand_effekt
            name: Okänd
            type: area
            color: "#9e9e9e"
            opacity: 0.5
            group_by:
              func: avg
              duration: 15m

  - title: Statistik
    path: statistik
    icon: mdi:chart-line
    type: custom:grid-layout
    layout:
      grid-template-columns: 1fr 1fr
      grid-template-rows: auto
      grid-template-areas: |
        "power price"
        "energy energy"
    cards:
      # Left - 7 day power
      - type: custom:apexcharts-card
        view_layout:
          grid-area: power
        header:
          show: true
          title: Effekt (7 dagar)
        graph_span: 7d
        apex_config:
          chart:
            height: 300
          stroke:
            width: 2
        series:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Effekt
            type: line
            color: "#2196f3"
            group_by:
              func: avg
              duration: 1h

      # Right - 7 day price
      - type: custom:apexcharts-card
        view_layout:
          grid-area: price
        header:
          show: true
          title: Elpris (7 dagar)
        graph_span: 7d
        apex_config:
          chart:
            height: 300
          stroke:
            width: 2
        series:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
            type: area
            color: "#4caf50"
            opacity: 0.3

      # Bottom - 7 day energy (full width)
      - type: history-graph
        view_layout:
          grid-area: energy
        title: Energi (7 dagar)
        hours_to_show: 168
        entities:
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_forbrukad
            name: Import
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_producerad
            name: Export

  - title: Kostnader
    path: kostnader
    icon: mdi:currency-usd
    type: custom:grid-layout
    layout:
      grid-template-columns: 1fr 1fr 1fr
      grid-template-rows: auto
      grid-template-areas: |
        "metrics metrics metrics"
        "stats costs chart"
        "stats costs chart"
    cards:
      # Price cards - full width
      - type: horizontal-stack
        view_layout:
          grid-area: metrics
        cards:
          - type: custom:mushroom-entity-card
            entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
            icon: mdi:flash
            icon_color: green
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-green), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.elpris_skelleftea_kraft
            name: Totalpris
            icon: mdi:cash
            icon_color: amber
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-amber), 0.1);
                }
          - type: custom:mushroom-entity-card
            entity: sensor.ersattning_solproduktion
            name: Ersättning
            icon: mdi:solar-power-variant
            icon_color: orange
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-orange), 0.1);
                }

      # Left - Price stats
      - type: entities
        view_layout:
          grid-area: stats
        title: Prisstatistik Idag
        entities:
          - entity: sensor.elpris_lagsta_idag
            name: Lägsta
          - entity: sensor.elpris_hogsta_idag
            name: Högsta
          - entity: sensor.elpris_medel_idag
            name: Medel

      # Middle - Costs summary
      - type: entities
        view_layout:
          grid-area: costs
        title: Kostnadsöversikt
        entities:
          - type: section
            label: Energikostnader
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_forbrukad_cost
            name: Import
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_producerad_compensation
            name: Solersättning
          - type: section
            label: Effekttariff
          - entity: sensor.peak_power_top_5_average
            name: Topp 5 medel
          - entity: sensor.effektavgift_manad
            name: Månadsavgift

      # Right - 48h price chart
      - type: custom:apexcharts-card
        view_layout:
          grid-area: chart
        header:
          show: true
          title: Elpris (48h)
        graph_span: 48h
        apex_config:
          chart:
            height: 300
          stroke:
            width: 2
        series:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
            type: line
            color: "#4caf50"
