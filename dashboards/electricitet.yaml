title: Electricitet
views:
  - title: Översikt
    path: oversikt
    icon: mdi:flash
    cards:
      # Current electricity price
      - type: entities
        title: Aktuella Priser
        entities:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris (Nord Pool SE3)
          - entity: sensor.elpris_skelleftea_kraft
            name: Totalpris (inkl. påslag)
          - entity: sensor.ersattning_solproduktion
            name: Ersättning solproduktion

      # Effekttariff section
      - type: entities
        title: Effekttariff
        entities:
          - entity: sensor.peak_power_top_5_average
            name: Topp 5 medel (kW)
          - entity: sensor.effektavgift_manad
            name: Effektavgift denna månad

      # Current power usage
      - type: gauge
        entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
        name: Aktuell Effekt
        unit: W
        min: 0
        max: 10000
        severity:
          green: 0
          yellow: 3000
          red: 6000

      # Electricity price chart - Today & Tomorrow
      - type: custom:apexcharts-card
        header:
          show: true
          title: Elpris Idag & Imorgon
        graph_span: 48h
        span:
          start: day
        now:
          show: true
          label: Nu
        yaxis:
          - id: price
            min: 0
        series:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
            type: column
            yaxis_id: price
            data_generator: |
              const today = entity.attributes.raw_today || [];
              const tomorrow = entity.attributes.raw_tomorrow || [];
              return today.concat(tomorrow).map((d) => [new Date(d.start).getTime(), d.value]);
            color: rgb(33, 150, 243)

      # Power consumption over time
      - type: history-graph
        title: Effekt (24h)
        entities:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Effekt
        hours_to_show: 24

  - title: Energi
    path: energi
    icon: mdi:lightning-bolt
    cards:
      # Energy import/export today
      - type: entities
        title: Energi Idag
        entities:
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_forbrukad
            name: Förbrukat från nät
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_producerad
            name: Exporterat till nät

      # Solar production
      - type: entities
        title: Solproduktion
        entities:
          - entity: sensor.solarnet_effekt_solceller
            name: Aktuell produktion
          - entity: sensor.fornvagen_19_linkoping_total_energi
            name: Total produktion (Wh)
          - entity: sensor.fornvagen_19_linkoping_inverterlage
            name: Inverter status

      # Real-time power flow
      - type: entities
        title: Effektflöde (realtid)
        entities:
          - entity: sensor.solarnet_elnat_import
            name: Import från nät
          - entity: sensor.solarnet_elnat_export
            name: Export till nät
          - entity: sensor.solarnet_forbrukad_effekt
            name: Total förbrukning
          - entity: sensor.solarnet_relativ_autonomi
            name: Självförsörjningsgrad

      # Energy flow diagram (if you have the energy-flow-card)
      - type: energy-distribution
        link_dashboard: true

  - title: Effekttariff
    path: effekttariff
    icon: mdi:chart-timeline-variant
    cards:
      # Current month summary
      - type: entities
        title: Effekttariff - Aktuell Månad
        entities:
          - entity: sensor.peak_power_top_5_average
            name: Topp 5 medel
          - entity: sensor.effektavgift_manad
            name: Beräknad månadsavgift

      # Monthly power chart with hourly max aggregation
      - type: custom:apexcharts-card
        header:
          show: true
          title: Effekt denna månad (timmedel)
          show_states: true
        graph_span: 31d
        span:
          start: month
        yaxis:
          - id: power
            min: 0
            apex_config:
              forceNiceScale: true
        apex_config:
          chart:
            height: 400
          stroke:
            width: 1
          annotations:
            yaxis:
              - y: 3000
                borderColor: "#FFA500"
                label:
                  text: "3 kW"
                  style:
                    background: "#FFA500"
              - y: 5000
                borderColor: "#FF0000"
                label:
                  text: "5 kW"
                  style:
                    background: "#FF0000"
        series:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Max per timme
            type: line
            yaxis_id: power
            stroke_width: 1
            color: "#2196F3"
            group_by:
              func: max
              duration: 1h
            show:
              extremas: true

      # Info card explaining the calculation
      - type: markdown
        title: Om Effekttariff
        content: |
          **Så beräknas effektavgiften:**

          1. Varje timmes högsta effekt (W) registreras
          2. De 5 högsta timmedelvärdena under månaden väljs ut
          3. Medelvärdet av dessa 5 toppar beräknas
          4. Avgiften = medelvärde × tariff

          **Tariffer:**
          - Sommar (apr-okt): **22 kr/kW**
          - Vinter (nov-mar): **43 kr/kW**

          **Tips för att sänka effektavgiften:**
          - Undvik att köra flera stora förbrukare samtidigt
          - Fördela tvätt, disk, laddning över tid
          - Använd timer för att sprida last

  - title: Statistik
    path: statistik
    icon: mdi:chart-line
    cards:
      # Monthly energy statistics
      - type: history-graph
        title: Energiförbrukning (7 dagar)
        entities:
          - entity: sensor.smart_meter_ts_65a_3_verklig_energi_forbrukad
            name: Förbrukat
        hours_to_show: 168

      # Price statistics
      - type: history-graph
        title: Elpris (7 dagar)
        entities:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
        hours_to_show: 168

      # Peak power tracking
      - type: history-graph
        title: Effekttoppar (7 dagar)
        entities:
          - entity: sensor.smart_meter_ts_65a_3_aktiv_effekt
            name: Effekt
        hours_to_show: 168

  - title: Kostnader
    path: kostnader
    icon: mdi:currency-usd
    cards:
      # Current costs overview
      - type: markdown
        title: Kostnadssammanställning
        content: |
          ## Aktuella priser

          | Typ | Pris |
          |-----|------|
          | Spotpris | {{ states('sensor.nordpool_kwh_se3_sek_3_10_025') }} SEK/kWh |
          | Totalpris | {{ states('sensor.elpris_skelleftea_kraft') }} SEK/kWh |
          | Solersättning | {{ states('sensor.ersattning_solproduktion') }} SEK/kWh |

          ## Effekttariff

          | Mått | Värde |
          |------|-------|
          | Topp 5 medel | {{ states('sensor.peak_power_top_5_average') }} kW |
          | Månadsavgift | {{ states('sensor.effektavgift_manad') }} SEK |

          ---
          *Säsong: {{ 'Sommar (22 kr/kW)' if now().month >= 4 and now().month <= 10 else 'Vinter (43 kr/kW)' }}*

      # Price comparison chart
      - type: custom:apexcharts-card
        header:
          show: true
          title: Priskomponenter
        chart_type: donut
        series:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Spotpris
            color: rgb(33, 150, 243)
          - entity: sensor.elpris_skelleftea_kraft
            name: Påslag
            color: rgb(76, 175, 80)
            transform: "return x - hass.states['sensor.nordpool_kwh_se3_sek_3_10_025'].state;"
