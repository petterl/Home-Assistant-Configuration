# =============================================================================
# HOME ASSISTANT CONFIGURATION
# =============================================================================
# Infrastructure:
#   - Home Assistant: 192.168.1.60 (Proxmox VM)
#   - MariaDB: 192.168.1.61:3306 (LXC, 10-day retention)
#   - InfluxDB: 192.168.1.62:8086 (LXC, long-term storage)
#   - MQTT: 192.168.1.63:1883 (Mosquitto, LXC)
#   - Zigbee2MQTT: localhost:8099 (Add-on, ConBee II)
# =============================================================================

# Default Home Assistant setup (frontend, api, etc)
default_config:

# HTTP configuration
http:
  ip_ban_enabled: true
  login_attempts_threshold: 5
  use_x_forwarded_for: true
  trusted_proxies:
    - 192.168.1.70
    - 192.168.1.0/24
    - 172.30.32.0/23 # Supervisor/Add-ons internal network
    - 172.30.33.0/24 # Supervisor/Add-ons internal network

# Frontend themes
frontend:
  themes: !include_dir_merge_named themes

# =============================================================================
# LOVELACE DASHBOARDS
# =============================================================================
lovelace:
  mode: storage
  dashboards:
    lovelace-elektricitet:
      mode: yaml
      title: Elektricitet
      icon: mdi:flash
      show_in_sidebar: true
      filename: dashboards/elektricitet.yaml
    lovelace-klimat:
      mode: yaml
      title: Klimat
      icon: mdi:thermometer
      show_in_sidebar: true
      filename: dashboards/klimat.yaml
    lovelace-batteri:
      mode: yaml
      title: Batteri
      icon: mdi:battery
      show_in_sidebar: true
      filename: dashboards/batteri.yaml
    lovelace-system:
      mode: yaml
      title: System
      icon: mdi:cog
      show_in_sidebar: true
      filename: dashboards/system.yaml

# =============================================================================
# INCLUDED FILES
# =============================================================================
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# =============================================================================
# INPUT HELPERS
# =============================================================================
input_button:
  generate_claude_snapshot:
    name: "Generate Claude Snapshot"
    icon: mdi:robot
  git_push:
    name: "Git Push"
    icon: mdi:cloud-upload

input_boolean:
  export_begransning_aktiv:
    name: "Exportbegränsning aktiv"
    icon: mdi:transmission-tower-export
  solceller_export_begransad:
    name: "Solceller export begränsad"
    icon: mdi:solar-power-variant-outline

# =============================================================================
# UTILITY METERS - Track consumption per period
# =============================================================================
utility_meter:
  # Water consumption per month
  vatten_manad:
    source: sensor.water_meter_t_display_total_water_consumption
    name: "Vattenförbrukning Månad"
    cycle: monthly
  # Water consumption per year
  vatten_ar:
    source: sensor.water_meter_t_display_total_water_consumption
    name: "Vattenförbrukning År"
    cycle: yearly

input_number:
  export_begransning_pris:
    name: "Prisgräns för export"
    icon: mdi:currency-usd
    min: -1
    max: 2
    step: 0.1
    unit_of_measurement: "SEK/kWh"
    initial: 0

# =============================================================================
# SHELL COMMANDS
# =============================================================================
shell_command:
  git_pull: "cd /config && git pull origin master 2>&1"
  git_pull_force: "cd /config && git fetch origin && git reset --hard origin/master 2>&1"
  git_status: "cd /config && git status --short 2>&1"
  git_diff_files: "cd /config && git diff --name-only HEAD~1 HEAD 2>&1"
  git_has_local_changes: "cd /config && git status --porcelain 2>&1"
  git_untracked_files: "cd /config && git ls-files --others --exclude-standard 2>&1"
  git_smart_commit_push: "/config/scripts/git_commit_and_push.sh"
  # Note: file parameter should be a simple filename, not a path with special chars
  git_add_file: 'cd /config && git add "{{ file }}"'
  git_ignore_file: 'echo "{{ file }}" >> /config/.gitignore'
  generate_claude_snapshot: "python3 /config/scripts/generate_claude_snapshot.py"

# =============================================================================
# INTEGRATIONS
# =============================================================================

# Camera streaming
stream:

# =============================================================================
# NOTIFICATION GROUPS
# =============================================================================
notify:
  - platform: group
    name: "Vitvaror varningar"
    services:
      - service: mobile_app_petter_iphone
      - service: persistent_notification  # Fallback if phone unreachable

# =============================================================================
# ALERTS - Critical System Monitoring
# =============================================================================
alert:
  zigbee2mqtt_offline:
    name: "Zigbee2MQTT offline"
    entity_id: binary_sensor.zigbee2mqtt_bridge_connection_state
    state: "off"
    repeat:
      - 15
      - 30
      - 60
    can_acknowledge: true
    skip_first: false
    notifiers:
      - mobile_app_petter_iphone
    title: "⚠️ Zigbee2MQTT"
    message: "Zigbee2MQTT-bryggan har tappat anslutningen"

  disk_space_low:
    name: "Disk space low"
    entity_id: binary_sensor.disk_low
    state: "on"
    repeat:
      - 60
      - 360
    can_acknowledge: true
    skip_first: false
    notifiers:
      - mobile_app_petter_iphone
    title: "⚠️ Diskutrymme"
    message: "Diskutrymmet är över 85% - kontrollera loggar och databas"

  memory_high:
    name: "Memory usage high"
    entity_id: binary_sensor.memory_high
    state: "on"
    repeat:
      - 30
      - 60
    can_acknowledge: true
    skip_first: true
    notifiers:
      - mobile_app_petter_iphone
    title: "⚠️ Minne"
    message: "Minnesanvändningen är över 90%"

# =============================================================================
# LOGGING
# =============================================================================
logger:
  default: warning
  # logs:
  #   custom_components.sector_alarm: info

# =============================================================================
# MODBUS - Fronius GEN24 Inverter
# =============================================================================
modbus:
  - name: fronius
    type: tcp
    host: 192.168.4.234
    port: 502
    sensors:
      - name: "Fronius Modbus AC Power"
        address: 40092
        input_type: holding
        slave: 1
        data_type: float32
        swap: word
        unit_of_measurement: "W"
        scan_interval: 30

# =============================================================================
# SENSORS
# =============================================================================
template: !include template_sensors.yaml
sql: !include sql_sensors.yaml

sensor: !include statistics_sensors.yaml

# =============================================================================
# COMMAND LINE SENSORS
# =============================================================================
command_line:
  - sensor:
      name: "Git Status"
      unique_id: git_status
      command: "cd /config && git log -1 --format='{\"hash\": \"%h\", \"message\": \"%s\", \"age\": \"%cr\"}'"
      value_template: "{{ value_json.hash }}"
      json_attributes:
        - hash
        - message
        - age
      scan_interval: 300

# =============================================================================
# RECORDER (MariaDB) - Short-term operational data
# =============================================================================
recorder:
  db_url: !secret mysql_url
  purge_keep_days: 10
  commit_interval: 1
  exclude:
    # Domains that don't need history
    domains:
      - automation
      - updater
      - script
      - scene
      - persistent_notification
      - input_button
    # Entity patterns to exclude (keep recorder leaner)
    entity_globs:
      # Time-based sensors
      - sensor.sun_*
      - sensor.*_uptime*
      - sensor.*_last_boot*
      - sensor.*_last_seen*
      - sensor.last_seen*        # iCloud3 sensors
      - sensor.*_last_update*
      - sensor.*_next_update*
      # Signal quality (too noisy, updates frequently)
      - sensor.rssi*             # Zigbee RSSI
      - sensor.*_linkquality*
      - sensor.*_wifi_signal*
      # Updates
      - binary_sensor.*_update*
      - update.*
    # Specific entities
    entities:
      - sun.sun
      - sensor.date
      - sensor.time
      - sensor.date_time
      - sensor.date_time_iso
      - sensor.time_date
      - sensor.time_utc

# =============================================================================
# INFLUXDB - Long-term analytics (Grafana, trends)
# =============================================================================
influxdb:
  host: 192.168.1.62
  port: 8086
  database: homeassistant
  username: homeassistant
  password: !secret influxdb_password
  max_retries: 3
  default_measurement: state
  # Only include specific domains for long-term storage
  include:
    domains:
      - sensor
      - binary_sensor
      - climate
      - weather
      - person
      - device_tracker
      - cover
    # Specific entities worth tracking
    entities:
      - switch.ugn_av_pa
      - switch.spishall_av_pa
      - switch.ftx
      - switch.casa
  exclude:
    # Exclude noisy/unneeded sensors from long-term storage
    entity_globs:
      # Time-based sensors (constant updates)
      - sensor.sun_*
      - sensor.*_uptime*
      - sensor.*_last_boot*
      - sensor.*_last_seen*
      - sensor.last_seen*        # iCloud3 sensors (no underscore prefix)
      - sensor.*_last_update*
      - sensor.*_next_update*
      # System monitoring (not useful for long-term trends)
      - sensor.system_monitor_*
      - sensor.*_cpu_utilization*
      - sensor.*_memory_utilization*
      - sensor.*_diskens_*       # UniFi disk write speed (Swedish)
      # Signal quality (too noisy)
      - sensor.rssi*             # Zigbee RSSI sensors
      - sensor.*_linkquality*
      - sensor.*_wifi_signal*
      # Updates
      - binary_sensor.*_update*
      - sensor.*_battery_level   # if using battery_notes
    entities:
      - sun.sun
      - sensor.date
      - sensor.time
      - sensor.date_time
      - sensor.date_time_iso
