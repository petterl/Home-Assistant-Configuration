# Loads default set of integrations. Do not remove.
default_config:

# =============================================================================
# HTTP / SSL
# =============================================================================
http:
  ssl_certificate: /ssl/fullchain.pem
  ssl_key: /ssl/privkey.pem
  ip_ban_enabled: true
  login_attempts_threshold: 5

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

# =============================================================================
# LOVELACE DASHBOARDS
# =============================================================================
lovelace:
  mode: storage
  dashboards:
    lovelace-electricitet:
      mode: yaml
      title: Electricitet
      icon: mdi:flash
      show_in_sidebar: true
      filename: dashboards/electricitet.yaml

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# =============================================================================
# INPUT HELPERS
# =============================================================================
input_button:
  generate_claude_snapshot:
    name: "Generate Claude Snapshot"
    icon: mdi:robot

# =============================================================================
# SHELL COMMANDS
# =============================================================================
shell_command:
  git_pull: "cd /config && git pull origin master 2>&1"
  git_pull_force: "cd /config && git fetch origin && git reset --hard origin/master 2>&1"
  git_status: "cd /config && git status --short 2>&1"
  generate_claude_snapshot: "python3 /config/scripts/generate_claude_snapshot.py"

# =============================================================================
# TEMPLATE SENSORS
# =============================================================================
template:
  - sensor:
      - name: "Elpris Skellefteå Kraft"
        unique_id: elpris_skelleftea_kraft
        unit_of_measurement: "SEK/kWh"
        device_class: monetary
        state: >
          {% set spot = states('sensor.nordpool_kwh_se3_sek_3_10_025') | float(0) %}
          {% set markup = 0.066 %}
          {{ (spot + markup) | round(4) }}
        attributes:
          spot_price: "{{ states('sensor.nordpool_kwh_se3_sek_3_10_025') }}"
          markup: "0.06 SEK/kWh"
          electricity_certificate: "0.006 SEK/kWh"
          monthly_fee: "39.20 SEK/month"

      - name: "Ersättning Solproduktion"
        unique_id: ersattning_solproduktion
        unit_of_measurement: "SEK/kWh"
        device_class: monetary
        state: >
          {% set spot = states('sensor.nordpool_kwh_se3_sek_3_10_025') | float(0) %}
          {% set bonus = 0.02 %}
          {{ (spot + bonus) | round(4) }}
        attributes:
          spot_price: "{{ states('sensor.nordpool_kwh_se3_sek_3_10_025') }}"
          production_bonus: "0.02 SEK/kWh"

      - name: "Effektavgift Månad"
        unique_id: effektavgift_manad
        unit_of_measurement: "SEK"
        device_class: monetary
        state: >
          {% set peak_kw = states('sensor.peak_power_top_5_average') | float(0) %}
          {% set month = now().month %}
          {% if month >= 4 and month <= 10 %}
            {% set rate = 22 %}
          {% else %}
            {% set rate = 43 %}
          {% endif %}
          {{ (peak_kw * rate) | round(2) }}
        attributes:
          peak_power_kw: "{{ states('sensor.peak_power_top_5_average') }}"
          season: "{{ 'summer' if now().month >= 4 and now().month <= 10 else 'winter' }}"
          rate_kr_per_kw: "{{ 22 if now().month >= 4 and now().month <= 10 else 43 }}"
          summer_rate: "22 kr/kW"
          winter_rate: "43 kr/kW"
          calculation_method: "Average of top 5 hourly peaks"

# =============================================================================
# PEAK POWER TRACKING - Top 5 hourly averages for effekttariff
# =============================================================================
sql:
  - name: "Peak Power Top 5 Average"
    db_url: !secret mysql_url
    query: "SELECT IFNULL(ROUND(AVG(hourly_max) / 1000, 3), 0) as top5_avg_kw FROM (SELECT MAX(s.state + 0) as hourly_max FROM states s JOIN states_meta sm ON s.metadata_id = sm.metadata_id WHERE sm.entity_id = 'sensor.smart_meter_ts_65a_3_aktiv_effekt' AND s.last_updated_ts >= UNIX_TIMESTAMP(LAST_DAY(NOW() - INTERVAL 1 MONTH) + INTERVAL 1 DAY) AND s.state REGEXP '^[0-9.]+$' AND s.state + 0 > 0 GROUP BY FLOOR(s.last_updated_ts / 3600) ORDER BY hourly_max DESC LIMIT 5) as top5"
    column: top5_avg_kw
    unit_of_measurement: "kW"
    device_class: power

# =============================================================================
# RECORDER (MariaDB) - Short-term operational data
# =============================================================================
recorder:
  db_url: !secret mysql_url
  purge_keep_days: 10
  commit_interval: 1
  exclude:
    # Domains that don't need history
    domains:
      - automation
      - updater
      - script
      - scene
      - persistent_notification
      - input_button
    # Entity patterns to exclude
    entity_globs:
      - sensor.sun_*
      - sensor.*_uptime*
      - sensor.*_last_boot*
      - sensor.*_last_seen*
      - binary_sensor.*_update*
      - update.*
    # Specific entities
    entities:
      - sun.sun
      - sensor.date
      - sensor.time
      - sensor.date_time
      - sensor.date_time_iso
      - sensor.time_date
      - sensor.time_utc

# =============================================================================
# INFLUXDB - Long-term analytics (Grafana, trends)
# =============================================================================
influxdb:
  host: 192.168.1.62
  port: 8086
  database: homeassistant
  username: homeassistant
  password: !secret influxdb_password
  max_retries: 3
  default_measurement: state
  # Only include specific domains for long-term storage
  include:
    domains:
      - sensor
      - binary_sensor
      - climate
      - weather
      - person
      - device_tracker
  exclude:
    # Exclude noisy/unneeded sensors
    entity_globs:
      - sensor.sun_*
      - sensor.*_uptime*
      - sensor.*_last_boot*
      - sensor.*_last_seen*
      - sensor.*_battery_level # if using battery_notes
      - binary_sensor.*_update*
      - sensor.*_memory*
      - sensor.*_cpu*
      - sensor.*_disk*
    entities:
      - sun.sun
      - sensor.date
      - sensor.time
      - sensor.date_time
      - sensor.date_time_iso
