# ESPHome configuration for Kamstrup Multical 21 Water Meter Reader
# Uses CC1101 radio module to receive wM-Bus Mode C1 transmissions
#
# Hardware connections for LOLIN D1 Mini:
#   CC1101 VCC  -> 3V3
#   CC1101 GND  -> GND
#   CC1101 SCK  -> D5 (GPIO14)
#   CC1101 MISO -> D7 (GPIO13)  # Note: Labels are from CC1101 perspective
#   CC1101 MOSI -> D6 (GPIO12)  # Note: Labels are from CC1101 perspective
#   CC1101 CSN  -> D1 (GPIO5)
#   CC1101 GDO0 -> D2 (GPIO4)

substitutions:
  device_name: watermeter
  friendly_name: "Water Meter"
  # Get meter_id from the sticker on your meter (8 hex chars)
  meter_id: !secret multical21_meter_id
  # Get encryption key from your water provider (32 hex chars)
  meter_key: !secret multical21_meter_key

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp8266:
  board: d1_mini

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: true
  power_save_mode: none

  # Enable fallback hotspot in case wifi connection fails
  #ap:
  #  ssid: "${device_name} Fallback"
  #  password: !secret ap_password
  # captive_portal:

# Status LED (built-in LED on D1 Mini is GPIO2/D4)
status_led:
  pin:
    number: GPIO2
    inverted: true

# SPI bus for CC1101
spi:
  id: spi_bus
  clk_pin: GPIO14   # D5
  mosi_pin: GPIO13  # D7
  miso_pin: GPIO12  # D6

# External custom components
external_components:
  - source: github://petterl/esp32-multical21@master
    components: [multical21]

# Multical21 water meter sensor
multical21:
  id: water_meter
  spi_id: spi_bus
  cs_pin: GPIO5    # D1
  gdo0_pin: GPIO4  # D2
  meter_id: ${meter_id}
  key: ${meter_key}

sensor:
  # Total water consumption
  - platform: multical21
    multical21_id: water_meter
    total_consumption:
      name: "Total Water Consumption"
      icon: "mdi:water"
    month_start_value:
      name: "Month Start Value"
      icon: "mdi:calendar-month"
    water_temperature:
      name: "Water Temperature"
      icon: "mdi:thermometer-water"
    ambient_temperature:
      name: "Ambient Temperature"
      icon: "mdi:thermometer"

  # WiFi signal strength
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  # Uptime sensor
  - platform: uptime
    name: "Uptime"

text_sensor:
  # Last update timestamp
  - platform: multical21
    multical21_id: water_meter
    last_update:
      name: "Last Update"
      icon: "mdi:clock-outline"

  # WiFi info
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"

binary_sensor:
  # Connection status
  - platform: status
    name: "Status"

button:
  # Restart button
  - platform: restart
    name: "Restart"
