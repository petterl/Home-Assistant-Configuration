- id: ida_knapp_rullgardin
  alias: Ida knapp - Rullgardin
  description: Styr Idas rullgardin med knapp
  use_blueprint:
    path: custom/blind_button_control.yaml
    input:
      mqtt_topic: zigbee2mqtt/Ida tryckknapp/action
      cover_entity: cover.idas_rullgardin
      down_position: 46
      up_position: 100
- id: moa_knapp_rullgardin
  alias: Moa knapp - Rullgardin
  description: Styr Moas rullgardin med knapp
  use_blueprint:
    path: custom/blind_button_control.yaml
    input:
      mqtt_topic: zigbee2mqtt/Moa tryckknapp/action
      cover_entity: cover.moas_rullgardin
      down_position: 46
      up_position: 100
- id: gastrum_knapp_gardiner
  alias: Gästrum knapp - Gardiner
  description: Styr Gästrums gardiner med knapp
  use_blueprint:
    path: custom/blind_button_control.yaml
    input:
      mqtt_topic: zigbee2mqtt/Gästrum tryckknapp/action
      cover_entity: cover.gastrum_gardiner
      down_position: 46
      up_position: 100
- id: git_pull_on_webhook
  alias: Git - Pull vid GitHub push
  description: Hämtar config från GitHub när webhook triggas, varnar om lokala ändringar finns
  trigger:
  - platform: webhook
    webhook_id: 60f082f2d2ff6fcb26bd51d7a79e3d22fb233ebbbf18b29d2ce7ce0cc2e588cc
    allowed_methods:
    - POST
    local_only: false
  action:
  - service: shell_command.git_has_local_changes
    response_variable: local_status
  - variables:
      has_local_changes: "{{ local_status.stdout | default('') | length > 0 }}"
  - if:
    - condition: template
      value_template: "{{ has_local_changes }}"
    then:
    - service: persistent_notification.create
      data:
        title: 'Git: Lokala ändringar upptäckta!'
        message: >
          Det finns lokala ändringar som inte pushats:
          {{ local_status.stdout }}

          Använd knappen "Git Push" för att pusha ändringarna innan pull.
        notification_id: git_local_changes_warning
  - service: shell_command.git_pull
  - delay:
      seconds: 2
  - service: shell_command.git_diff_files
    response_variable: git_diff
  - variables:
      changed_files: "{{ git_diff.stdout | default('') }}"
      z2m_changed: "{{ 'zigbee2mqtt/' in changed_files }}"
      automations_changed: "{{ 'automations.yaml' in changed_files }}"
      scripts_changed: "{{ 'scripts.yaml' in changed_files }}"
      scenes_changed: "{{ 'scenes.yaml' in changed_files }}"
  - if:
    - condition: template
      value_template: "{{ automations_changed }}"
    then:
    - service: automation.reload
  - if:
    - condition: template
      value_template: "{{ scripts_changed }}"
    then:
    - service: script.reload
  - if:
    - condition: template
      value_template: "{{ scenes_changed }}"
    then:
    - service: scene.reload
  - if:
    - condition: template
      value_template: "{{ z2m_changed }}"
    then:
    - service: hassio.addon_restart
      data:
        addon: 45df7312_zigbee2mqtt
  - service: persistent_notification.create
    data:
      title: Git Pull
      message: >
        Config uppdaterad: {{ now().strftime('%Y-%m-%d %H:%M') }}
        {% if automations_changed %}✓ Automations{% endif %}
        {% if scripts_changed %}✓ Scripts{% endif %}
        {% if scenes_changed %}✓ Scenes{% endif %}
        {% if z2m_changed %}✓ Zigbee2MQTT{% endif %}
        {% if not (automations_changed or scripts_changed or scenes_changed or z2m_changed) %}(inga reloads behövdes){% endif %}
      notification_id: git_pull_status
  mode: single
- id: git_pull_on_startup
  alias: Git - Pull vid uppstart
  description: Hämtar senaste config från GitHub när HA startar
  trigger:
  - platform: homeassistant
    event: start
  action:
  - delay:
      seconds: 30
  - service: shell_command.git_pull
  - service: persistent_notification.create
    data:
      title: Uppstart Git Pull
      message: 'Config synkad från GitHub vid uppstart: {{ now().strftime(''%Y-%m-%d
        %H:%M'') }}'
      notification_id: git_pull_startup
  mode: single
- id: git_pull_scheduled
  alias: Git - Schemalagd pull
  description: 'Backup: hämtar config från GitHub var 6:e timme'
  trigger:
  - platform: time_pattern
    hours: /6
  action:
  - service: shell_command.git_pull
  mode: single
- id: claude_snapshot_on_demand
  alias: Claude - Generate Snapshot
  description: Generates a live HA snapshot for Claude Desktop when button is pressed
  trigger:
  - platform: event
    event_type: call_service
    event_data:
      domain: input_button
      service: press
      service_data:
        entity_id: input_button.generate_claude_snapshot
  action:
  - service: script.generate_claude_snapshot
  mode: single
- id: effekt_peak_varning
  alias: Effekt - Varning vid ny topp
  description: Varnar när nuvarande effekt närmar sig eller överskrider 5:e högsta
    toppen
  trigger:
  - platform: numeric_state
    entity_id: sensor.smart_meter_ts_65a_3_aktiv_effekt
    above: 1
    id: check_peak
  condition:
  - condition: template
    value_template: '{% set current_w = states(''sensor.smart_meter_ts_65a_3_aktiv_effekt'')
      | float(0) %} {% set current_kw = current_w / 1000 %} {% set fifth_peak_kw =
      states(''sensor.peak_power_5th_highest'') | float(0) %} {% set threshold_kw
      = fifth_peak_kw * 0.9 %} {{ current_kw >= threshold_kw and fifth_peak_kw > 0
      }}

      '
  action:
  - variables:
      current_w: '{{ states(''sensor.smart_meter_ts_65a_3_aktiv_effekt'') | float(0)
        }}'
      current_kw: '{{ (current_w / 1000) | round(2) }}'
      fifth_peak_kw: '{{ states(''sensor.peak_power_5th_highest'') | float(0) }}'
      avg_peak_kw: '{{ states(''sensor.peak_power_top_5_average'') | float(0) }}'
      is_new_peak: '{{ (current_w / 1000) > fifth_peak_kw | float(0) }}'
      month: '{{ now().month }}'
      rate: '{{ 22 if month >= 4 and month <= 10 else 43 }}'
      extra_cost: '{{ (((current_w / 1000) - avg_peak_kw) * rate) | round(2) if is_new_peak
        else 0 }}'
  - service: persistent_notification.create
    data:
      title: '{% if is_new_peak %}NY EFFEKTTOPP!{% else %}Varning: Hög effekt{% endif
        %}

        '
      message: 'Nuvarande effekt: {{ current_kw }} kW 5:e högsta topp: {{ fifth_peak_kw
        }} kW Snitt topp 5: {{ avg_peak_kw }} kW {% if is_new_peak %} Uppskattad extra
        månadskostnad: {{ extra_cost }} kr {% endif %} Minska förbrukningen genom
        att stänga av tunga laster!

        '
      notification_id: effekt_peak_warning
  - service: notify.mobile_app_petter_iphone
    data:
      title: '{% if is_new_peak %}NY EFFEKTTOPP!{% else %}Hög effekt{% endif %}

        '
      message: '{{ current_kw }} kW {% if is_new_peak %}(+{{ extra_cost }} kr/mån){%
        endif %} Minska förbrukningen!

        '
      data:
        push:
          sound:
            name: default
            critical: 1
            volume: 0.5
        tag: effekt_peak_warning
  mode: single
- id: git_push_on_button
  alias: Git - Push lokala ändringar
  description: Pushar lokala config-ändringar till GitHub vid knapptryck (kräver att ospårade filer hanteras först)
  trigger:
  - platform: state
    entity_id: input_button.git_push
  action:
  - service: shell_command.git_untracked_files
    response_variable: untracked_result
  - variables:
      has_untracked: "{{ untracked_result.stdout | default('') | length > 0 }}"
      untracked_files: "{{ untracked_result.stdout | default('') }}"
  - if:
    - condition: template
      value_template: "{{ has_untracked }}"
    then:
    - service: persistent_notification.create
      data:
        title: "Git: Ospårade filer!"
        message: >
          Det finns ospårade filer som måste hanteras innan push:

          {{ untracked_files }}

          Lägg till dem i git eller .gitignore först.
        notification_id: git_push_status
    - stop: Untracked files exist
  - service: shell_command.git_has_local_changes
    response_variable: local_status
  - variables:
      has_local_changes: "{{ local_status.stdout | default('') | length > 0 }}"
      changed_files: "{{ local_status.stdout | default('') }}"
  - if:
    - condition: template
      value_template: "{{ not has_local_changes }}"
    then:
    - service: persistent_notification.create
      data:
        title: Git Push
        message: Inga lokala ändringar att pusha.
        notification_id: git_push_status
    - stop: No local changes
  - service: shell_command.git_smart_commit_push
    response_variable: push_result
  - service: persistent_notification.create
    data:
      title: Git Push
      message: >
        {% if push_result.returncode == 0 %}
        {{ push_result.stdout }}

        Filer: {{ changed_files }}
        {% else %}
        Push misslyckades: {{ push_result.stderr | default(push_result.stdout) }}
        {% endif %}
      notification_id: git_push_status
  mode: single
- id: git_untracked_files_notification
  alias: Git - Notifiera om ospårade filer
  description: Kontrollerar efter nya filer som inte spåras av git och frågar vad som ska göras
  trigger:
  - platform: time_pattern
    hours: /6
  - platform: homeassistant
    event: start
  action:
  - delay:
      seconds: 60
  - service: shell_command.git_untracked_files
    response_variable: untracked_result
  - variables:
      has_untracked: "{{ untracked_result.stdout | default('') | length > 0 }}"
      untracked_files: "{{ untracked_result.stdout | default('') }}"
      file_count: "{{ untracked_result.stdout.strip().split('\n') | length if untracked_result.stdout else 0 }}"
  - if:
    - condition: template
      value_template: "{{ has_untracked }}"
    then:
    - service: notify.mobile_app_petter_iphone
      data:
        title: "Git: {{ file_count }} ospårade filer"
        message: >
          Nya filer upptäckta:
          {{ untracked_files }}

          Lägg till i git eller .gitignore?
        data:
          actions:
          - action: GIT_ADD_FILES
            title: Lägg till i git
          - action: GIT_IGNORE_FILES
            title: Lägg till i .gitignore
          - action: GIT_IGNORE_NOTIFICATION
            title: Ignorera
          tag: git_untracked_files
  mode: single
- id: git_untracked_files_response
  alias: Git - Hantera svar om ospårade filer
  description: Hanterar användarens val för ospårade filer
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: GIT_ADD_FILES
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: GIT_IGNORE_FILES
  action:
  - service: shell_command.git_untracked_files
    response_variable: untracked_result
  - variables:
      files: "{{ untracked_result.stdout | default('') }}"
      action: "{{ trigger.event.data.action }}"
  - if:
    - condition: template
      value_template: "{{ action == 'GIT_ADD_FILES' }}"
    then:
    - service: shell_command.git_add_file
      data:
        file: "{{ files.replace('\n', ' ') }}"
    - service: persistent_notification.create
      data:
        title: Git
        message: "Filer tillagda i git: {{ files }}"
        notification_id: git_untracked_response
  - if:
    - condition: template
      value_template: "{{ action == 'GIT_IGNORE_FILES' }}"
    then:
    - repeat:
        for_each: "{{ files.strip().split('\n') }}"
        sequence:
        - service: shell_command.git_ignore_file
          data:
            file: "{{ repeat.item }}"
    - service: persistent_notification.create
      data:
        title: Git
        message: "Filer tillagda i .gitignore: {{ files }}"
        notification_id: git_untracked_response
  mode: single
# =============================================================================
# REFRIGERATOR AUTOMATIONS (using blueprints)
# =============================================================================
# Door open warnings
- id: hoger_kyl_dorr_blueprint
  alias: Kök kyl höger - Dörr öppen (blueprint)
  description: Varnar om höger kyldörr varit öppen för länge
  use_blueprint:
    path: custom/appliance_door_warning.yaml
    input:
      door_sensor: binary_sensor.hoger_kyl_door_open
      appliance_name: "Höger kyl"
      door_open_minutes: 5
      notify_service: notify.vitvaror_varningar
      critical_sound: true

- id: vanster_kyl_dorr_blueprint
  alias: Kök kyl vänster - Dörr öppen (blueprint)
  description: Varnar om vänster kyldörr varit öppen för länge
  use_blueprint:
    path: custom/appliance_door_warning.yaml
    input:
      door_sensor: binary_sensor.vanster_kyl_door_open
      appliance_name: "Vänster kyl"
      door_open_minutes: 5
      notify_service: notify.vitvaror_varningar
      critical_sound: true

# Temperature warnings
- id: hoger_kyl_fridge_temp_blueprint
  alias: Kök kyl höger - Kylskåp temp (blueprint)
  description: Varnar om höger kylskåp är för varmt
  use_blueprint:
    path: custom/appliance_temp_warning.yaml
    input:
      temp_sensor: sensor.hoger_kyl_fridge_temp
      climate_entity: climate.hoger_kyl_fridge
      appliance_name: "Höger kylskåp"
      temp_threshold: 5
      default_target_temp: 4
      duration_minutes: 10
      notify_service: notify.vitvaror_varningar

- id: hoger_kyl_freezer_temp_blueprint
  alias: Kök kyl höger - Frys temp (blueprint)
  description: Varnar om höger frys är för varm
  use_blueprint:
    path: custom/appliance_temp_warning.yaml
    input:
      temp_sensor: sensor.hoger_kyl_freezer_temp
      climate_entity: climate.hoger_kyl_freezer
      appliance_name: "Höger frys"
      temp_threshold: 5
      default_target_temp: -18
      duration_minutes: 10
      notify_service: notify.vitvaror_varningar

- id: vanster_kyl_fridge_temp_blueprint
  alias: Kök kyl vänster - Kylskåp temp (blueprint)
  description: Varnar om vänster kylskåp är för varmt
  use_blueprint:
    path: custom/appliance_temp_warning.yaml
    input:
      temp_sensor: sensor.vanster_kyl_fridge_temp
      climate_entity: climate.vanster_kyl_fridge
      appliance_name: "Vänster kylskåp"
      temp_threshold: 5
      default_target_temp: 4
      duration_minutes: 10
      notify_service: notify.vitvaror_varningar

- id: vanster_kyl_freezer_temp_blueprint
  alias: Kök kyl vänster - Frys temp (blueprint)
  description: Varnar om vänster frys är för varm
  use_blueprint:
    path: custom/appliance_temp_warning.yaml
    input:
      temp_sensor: sensor.vanster_kyl_freezer_temp
      climate_entity: climate.vanster_kyl_freezer
      appliance_name: "Vänster frys"
      temp_threshold: 5
      default_target_temp: -18
      duration_minutes: 10
      notify_service: notify.vitvaror_varningar

# =============================================================================
# SOLAR EXPORT CONTROL (Fronius Modbus)
# =============================================================================
# Controls solar export to grid based on electricity price.
# When price is below threshold, export is limited to prevent selling at loss.
#
# Fronius Modbus Registers (SunSpec):
#   40236 (WMaxLimPct_SF): Export power limit in % (0-100)
#                         0 = no export, 100 = full export
#   40246 (WMaxLim_Ena):  Export limit enable flag
#                         0 = disabled (normal operation)
#                         1 = enabled (limit active)
#
# To limit export: Set 40236=0, then 40246=1
# To restore:      Set 40246=0 (40236 value doesn't matter when disabled)
#
# Related entities:
#   - input_boolean.export_begransning_aktiv: Master on/off for this feature
#   - input_boolean.solceller_export_begransad: Current state (limited or not)
#   - input_number.export_begransning_pris: Price threshold (SEK/kWh)
#   - binary_sensor.export_pris_for_lagt: True when price < threshold
# =============================================================================

- id: solceller_stoppa_export_lagt_pris
  alias: Solceller - Stoppa export vid lågt pris
  description: Begränsar solcellsexport till 0% när elpriset understiger prisgränsen
  trigger:
  - platform: state
    entity_id: binary_sensor.export_pris_for_lagt
    to: "on"
  - platform: state
    entity_id: input_boolean.export_begransning_aktiv
    to: "on"
  condition:
  - condition: state
    entity_id: input_boolean.export_begransning_aktiv
    state: "on"
  - condition: state
    entity_id: input_boolean.solceller_export_begransad
    state: "off"
  - condition: state
    entity_id: binary_sensor.export_pris_for_lagt
    state: "on"
  action:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.solceller_export_begransad
  - service: modbus.write_register
    data:
      hub: fronius
      address: 40236
      unit: 1
      value: 0
  - service: modbus.write_register
    data:
      hub: fronius
      address: 40246
      unit: 1
      value: 1
  - service: notify.mobile_app_petter_iphone
    data:
      title: Solceller begränsade
      message: 'Elpris {{ states(''sensor.nordpool_kwh_se3_sek_3_10_025'') }} SEK/kWh
        (gräns: {{ states(''input_number.export_begransning_pris'') }} SEK/kWh)

        '
  mode: single
- id: solceller_aterstall_export
  alias: Solceller - Återställ export
  description: Återställer normal export när priset är över gränsen eller funktionen stängs av
  trigger:
  - platform: state
    entity_id: binary_sensor.export_pris_for_lagt
    to: "off"
  - platform: state
    entity_id: input_boolean.export_begransning_aktiv
    to: "off"
  condition:
  - condition: state
    entity_id: input_boolean.solceller_export_begransad
    state: "on"
  - condition: or
    conditions:
    - condition: state
      entity_id: input_boolean.export_begransning_aktiv
      state: "off"
    - condition: state
      entity_id: binary_sensor.export_pris_for_lagt
      state: "off"
  action:
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.solceller_export_begransad
  - service: modbus.write_register
    data:
      hub: fronius
      address: 40246
      unit: 1
      value: 0
  - service: notify.mobile_app_petter_iphone
    data:
      title: Solceller återställda
      message: 'Elpris {{ states(''sensor.nordpool_kwh_se3_sek_3_10_025'') }} SEK/kWh
        - normal produktion

        '
  mode: single
- id: solceller_startup_sync
  alias: Solceller - Synka vid uppstart
  description: Säkerställer att Modbus-register matchar input_boolean vid HA-start
  trigger:
  - platform: homeassistant
    event: start
  condition:
  - condition: state
    entity_id: input_boolean.export_begransning_aktiv
    state: 'on'
  action:
  - delay:
      seconds: 60
  - if:
    - condition: state
      entity_id: input_boolean.solceller_export_begransad
      state: 'on'
    then:
    - service: modbus.write_register
      data:
        hub: fronius
        address: 40236
        unit: 1
        value: 0
    - service: modbus.write_register
      data:
        hub: fronius
        address: 40246
        unit: 1
        value: 1
    else:
    - service: modbus.write_register
      data:
        hub: fronius
        address: 40246
        unit: 1
        value: 0
  mode: single
# Water leak detection - consolidated with time-based thresholds
# Night (01:00-05:00): 30 min - shorter because usage unlikely
# Day (05:00-01:00): 60 min - longer to avoid false positives during normal use
- id: vatten_lackage_natt
  alias: Vatten - Läckagevarning natt
  description: Varnar om vatten rinner kontinuerligt under natten (01-05) i mer än 30 minuter
  trigger:
  - platform: state
    entity_id: binary_sensor.vatten_rinner
    to: 'on'
    for:
      minutes: 30
  condition:
  - condition: time
    after: "01:00:00"
    before: "05:00:00"
  action:
  - service: notify.mobile_app_petter_iphone
    data:
      title: Vattenläckage?
      message: >
        Vatten har runnit i över 30 minuter ({{ states('sensor.water_meter_t_display_current_water_flow') }} L/h).
        Kontrollera toaletter, kranar och varmvattenberedare!
      data:
        push:
          sound:
            name: default
            critical: 1
            volume: 1.0
        tag: vatten_lackage
  - service: persistent_notification.create
    data:
      title: Vattenläckage?
      message: >
        Vatten har runnit kontinuerligt sedan {{ (now() - timedelta(minutes=30)).strftime('%H:%M') }}.
        Flöde: {{ states('sensor.water_meter_t_display_current_water_flow') }} L/h
        Daglig förbrukning: {{ states('sensor.water_meter_t_display_daily_water_consumption') }} L
      notification_id: vatten_lackage
  mode: single
- id: vatten_lackage_dag
  alias: Vatten - Läckagevarning dag
  description: Varnar om vatten rinner kontinuerligt under dagen (05-01) i mer än 60 minuter
  trigger:
  - platform: state
    entity_id: binary_sensor.vatten_rinner
    to: 'on'
    for:
      minutes: 60
  condition:
  # Use template to correctly handle time spanning midnight (05:00 to 01:00 next day)
  - condition: template
    value_template: "{{ not (1 <= now().hour < 5) }}"
  action:
  - service: notify.mobile_app_petter_iphone
    data:
      title: Möjligt vattenläckage
      message: >
        Vatten har runnit i över 60 minuter ({{ states('sensor.water_meter_t_display_current_water_flow') }} L/h).
        Kontrollera kranar, toaletter och varmvattenberedare.
      data:
        tag: vatten_lackage_dag
  - service: persistent_notification.create
    data:
      title: Möjligt vattenläckage
      message: >
        Vatten har runnit kontinuerligt sedan {{ (now() - timedelta(minutes=60)).strftime('%H:%M') }}.
        Flöde: {{ states('sensor.water_meter_t_display_current_water_flow') }} L/h
        Daglig förbrukning: {{ states('sensor.water_meter_t_display_daily_water_consumption') }} L
      notification_id: vatten_lackage_dag
  mode: single
