- id: ida_knapp_rullgardin_ner
  alias: "Ida knapp - Rullgardin ner"
  description: "Sänker Idas rullgardin till 46% och stänger av smartplug vid close-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Ida tryckknapp/action
      payload: close
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.idas_rullgardin
      data:
        position: 46
    - service: switch.turn_off
      target:
        entity_id: switch.ida_smartplug
  mode: single

- id: ida_knapp_rullgardin_upp
  alias: "Ida knapp - Rullgardin upp"
  description: "Höjer Idas rullgardin till 100% och slår på smartplug vid open-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Ida tryckknapp/action
      payload: open
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.idas_rullgardin
      data:
        position: 100
    - service: switch.turn_on
      target:
        entity_id: switch.ida_smartplug
  mode: single

- id: moa_knapp_rullgardin_ner
  alias: "Moa knapp - Rullgardin ner"
  description: "Sänker Moas rullgardin till 46% och stänger av smartplug vid close-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Moa tryckknapp/action
      payload: close
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.moa_rullgardin
      data:
        position: 46
    - service: switch.turn_off
      target:
        entity_id: switch.moa_smartplug
  mode: single

- id: moa_knapp_rullgardin_upp
  alias: "Moa knapp - Rullgardin upp"
  description: "Höjer Moas rullgardin till 100% och slår på smartplug vid open-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Moa tryckknapp/action
      payload: open
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.moa_rullgardin
      data:
        position: 100
    - service: switch.turn_on
      target:
        entity_id: switch.moa_smartplug
  mode: single

- id: gastrum_knapp_gardiner_ner
  alias: "Gästrum knapp - Gardiner ner"
  description: "Sänker Gästrums gardiner till 46% vid close-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Gästrum tryckknapp/action
      payload: close
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.gastrum_gardiner
      data:
        position: 46
  mode: single

- id: gastrum_knapp_gardiner_upp
  alias: "Gästrum knapp - Gardiner upp"
  description: "Höjer Gästrums gardiner till 100% vid open-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Gästrum tryckknapp/action
      payload: open
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.gastrum_gardiner
      data:
        position: 100
  mode: single

- id: git_pull_on_webhook
  alias: "Git - Pull vid GitHub push"
  description: "Hämtar config från GitHub när webhook triggas, varnar om lokala ändringar finns"
  trigger:
    - platform: webhook
      webhook_id: !secret github_webhook_id
      allowed_methods:
        - POST
      local_only: false
  action:
    # Check for local changes first
    - service: shell_command.git_has_local_changes
      response_variable: local_status
    - variables:
        has_local_changes: "{{ local_status.stdout | default('') | length > 0 }}"
    # Warn if local changes exist
    - if:
        - condition: template
          value_template: "{{ has_local_changes }}"
      then:
        - service: persistent_notification.create
          data:
            title: "Git: Lokala ändringar upptäckta!"
            message: >
              Det finns lokala ändringar som inte pushats:
              {{ local_status.stdout }}

              Använd knappen "Git Push" för att pusha ändringarna innan pull.
            notification_id: git_local_changes_warning
    # Continue with pull
    - service: shell_command.git_pull
    - delay:
        seconds: 2
    - service: shell_command.git_diff_files
      response_variable: git_diff
    - variables:
        changed_files: "{{ git_diff.stdout | default('') }}"
        z2m_changed: "{{ 'zigbee2mqtt/' in changed_files }}"
        automations_changed: "{{ 'automations.yaml' in changed_files }}"
        scripts_changed: "{{ 'scripts.yaml' in changed_files }}"
        scenes_changed: "{{ 'scenes.yaml' in changed_files }}"
    # Reload automations if changed
    - if:
        - condition: template
          value_template: "{{ automations_changed }}"
      then:
        - service: automation.reload
    # Reload scripts if changed
    - if:
        - condition: template
          value_template: "{{ scripts_changed }}"
      then:
        - service: script.reload
    # Reload scenes if changed
    - if:
        - condition: template
          value_template: "{{ scenes_changed }}"
      then:
        - service: scene.reload
    # Restart Z2M addon if its config changed
    - if:
        - condition: template
          value_template: "{{ z2m_changed }}"
      then:
        - service: hassio.addon_restart
          data:
            addon: 45df7312_zigbee2mqtt
    # Notification with what was reloaded
    - service: persistent_notification.create
      data:
        title: "Git Pull"
        message: >
          Config uppdaterad: {{ now().strftime('%Y-%m-%d %H:%M') }}
          {% if automations_changed %}✓ Automations{% endif %}
          {% if scripts_changed %}✓ Scripts{% endif %}
          {% if scenes_changed %}✓ Scenes{% endif %}
          {% if z2m_changed %}✓ Zigbee2MQTT{% endif %}
          {% if not (automations_changed or scripts_changed or scenes_changed or z2m_changed) %}(inga reloads behövdes){% endif %}
        notification_id: git_pull_status
  mode: single

- id: git_pull_on_startup
  alias: "Git - Pull vid uppstart"
  description: "Hämtar senaste config från GitHub när HA startar"
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay:
        seconds: 30
    - service: shell_command.git_pull
    - service: persistent_notification.create
      data:
        title: "Uppstart Git Pull"
        message: "Config synkad från GitHub vid uppstart: {{ now().strftime('%Y-%m-%d %H:%M') }}"
        notification_id: git_pull_startup
  mode: single

- id: git_pull_scheduled
  alias: "Git - Schemalagd pull"
  description: "Backup: hämtar config från GitHub var 6:e timme"
  trigger:
    - platform: time_pattern
      hours: "/6"
  action:
    - service: shell_command.git_pull
  mode: single

- id: claude_snapshot_on_demand
  alias: "Claude - Generate Snapshot"
  description: "Generates a live HA snapshot for Claude Desktop when button is pressed"
  trigger:
    - platform: event
      event_type: call_service
      event_data:
        domain: input_button
        service: press
        service_data:
          entity_id: input_button.generate_claude_snapshot
  action:
    - service: script.generate_claude_snapshot
  mode: single

- id: effekt_peak_varning
  alias: "Effekt - Varning vid ny topp"
  description: "Varnar när nuvarande effekt närmar sig eller överskrider 5:e högsta toppen"
  trigger:
    - platform: numeric_state
      entity_id: sensor.smart_meter_ts_65a_3_aktiv_effekt
      above: 1
      id: check_peak
  condition:
    - condition: template
      value_template: >
        {% set current_w = states('sensor.smart_meter_ts_65a_3_aktiv_effekt') | float(0) %}
        {% set current_kw = current_w / 1000 %}
        {% set fifth_peak_kw = states('sensor.peak_power_5th_highest') | float(0) %}
        {% set threshold_kw = fifth_peak_kw * 0.9 %}
        {{ current_kw >= threshold_kw and fifth_peak_kw > 0 }}
  action:
    - variables:
        current_w: "{{ states('sensor.smart_meter_ts_65a_3_aktiv_effekt') | float(0) }}"
        current_kw: "{{ (current_w / 1000) | round(2) }}"
        fifth_peak_kw: "{{ states('sensor.peak_power_5th_highest') | float(0) }}"
        avg_peak_kw: "{{ states('sensor.peak_power_top_5_average') | float(0) }}"
        is_new_peak: "{{ (current_w / 1000) > fifth_peak_kw | float(0) }}"
        month: "{{ now().month }}"
        rate: "{{ 22 if month >= 4 and month <= 10 else 43 }}"
        extra_cost: "{{ (((current_w / 1000) - avg_peak_kw) * rate) | round(2) if is_new_peak else 0 }}"
    - service: persistent_notification.create
      data:
        title: >
          {% if is_new_peak %}NY EFFEKTTOPP!{% else %}Varning: Hög effekt{% endif %}
        message: >
          Nuvarande effekt: {{ current_kw }} kW
          5:e högsta topp: {{ fifth_peak_kw }} kW
          Snitt topp 5: {{ avg_peak_kw }} kW
          {% if is_new_peak %}
          Uppskattad extra månadskostnad: {{ extra_cost }} kr
          {% endif %}
          Minska förbrukningen genom att stänga av tunga laster!
        notification_id: effekt_peak_warning
    # Push notification to phone
    - service: notify.mobile_app_petters_iphone
      data:
        title: >
          {% if is_new_peak %}NY EFFEKTTOPP!{% else %}Hög effekt{% endif %}
        message: >
          {{ current_kw }} kW {% if is_new_peak %}(+{{ extra_cost }} kr/mån){% endif %}
          Minska förbrukningen!
        data:
          push:
            sound:
              name: default
              critical: 1
              volume: 0.5
          tag: effekt_peak_warning
  mode: single

- id: git_push_on_button
  alias: "Git - Push lokala ändringar"
  description: "Pushar lokala config-ändringar till GitHub vid knapptryck"
  trigger:
    - platform: state
      entity_id: input_button.git_push
  action:
    # Check for local changes first
    - service: shell_command.git_has_local_changes
      response_variable: local_status
    - variables:
        has_local_changes: "{{ local_status.stdout | default('') | length > 0 }}"
    - if:
        - condition: template
          value_template: "{{ not has_local_changes }}"
      then:
        - service: persistent_notification.create
          data:
            title: "Git Push"
            message: "Inga lokala ändringar att pusha."
            notification_id: git_push_status
        - stop: "No local changes"
    # Add, commit and push
    - service: shell_command.git_add_commit_push
      data:
        pat: !secret github_pat
        repo: !secret github_repo
      response_variable: push_result
    - service: persistent_notification.create
      data:
        title: "Git Push"
        message: >
          {% if push_result.returncode == 0 %}
          Ändringar pushade till GitHub: {{ now().strftime('%Y-%m-%d %H:%M') }}
          {% else %}
          Push misslyckades: {{ push_result.stderr | default(push_result.stdout) }}
          {% endif %}
        notification_id: git_push_status
  mode: single
