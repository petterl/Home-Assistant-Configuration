- id: ida_knapp_rullgardin_ner
  alias: "Ida knapp - Rullgardin ner"
  description: "Sänker Idas rullgardin till 46% och stänger av smartplug vid close-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Ida tryckknapp/action
      payload: close
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.idas_rullgardin
      data:
        position: 46
    - service: switch.turn_off
      target:
        entity_id: switch.ida_smartplug
  mode: single

- id: ida_knapp_rullgardin_upp
  alias: "Ida knapp - Rullgardin upp"
  description: "Höjer Idas rullgardin till 100% och slår på smartplug vid open-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Ida tryckknapp/action
      payload: open
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.idas_rullgardin
      data:
        position: 100
    - service: switch.turn_on
      target:
        entity_id: switch.ida_smartplug
  mode: single

- id: moa_knapp_rullgardin_ner
  alias: "Moa knapp - Rullgardin ner"
  description: "Sänker Moas rullgardin till 46% och stänger av smartplug vid close-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Moa tryckknapp/action
      payload: close
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.moa_rullgardin
      data:
        position: 46
    - service: switch.turn_off
      target:
        entity_id: switch.moa_smartplug
  mode: single

- id: moa_knapp_rullgardin_upp
  alias: "Moa knapp - Rullgardin upp"
  description: "Höjer Moas rullgardin till 100% och slår på smartplug vid open-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Moa tryckknapp/action
      payload: open
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.moa_rullgardin
      data:
        position: 100
    - service: switch.turn_on
      target:
        entity_id: switch.moa_smartplug
  mode: single

- id: gastrum_knapp_gardiner_ner
  alias: "Gästrum knapp - Gardiner ner"
  description: "Sänker Gästrums gardiner till 46% vid close-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Gästrum tryckknapp/action
      payload: close
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.gastrum_gardiner
      data:
        position: 46
  mode: single

- id: gastrum_knapp_gardiner_upp
  alias: "Gästrum knapp - Gardiner upp"
  description: "Höjer Gästrums gardiner till 100% vid open-tryck"
  trigger:
    - platform: mqtt
      topic: zigbee2mqtt/Gästrum tryckknapp/action
      payload: open
  action:
    - service: cover.set_cover_position
      target:
        entity_id: cover.gastrum_gardiner
      data:
        position: 100
  mode: single

- id: git_pull_on_webhook
  alias: "Git - Pull vid GitHub push"
  description: "Hämtar config från GitHub när webhook triggas, laddar om endast det som ändrats"
  trigger:
    - platform: webhook
      webhook_id: !secret github_webhook_id
      allowed_methods:
        - POST
      local_only: false
  action:
    - service: shell_command.git_pull
    - delay:
        seconds: 2
    - service: shell_command.git_diff_files
      response_variable: git_diff
    - variables:
        changed_files: "{{ git_diff.stdout | default('') }}"
        z2m_changed: "{{ 'zigbee2mqtt/' in changed_files }}"
        automations_changed: "{{ 'automations.yaml' in changed_files }}"
        scripts_changed: "{{ 'scripts.yaml' in changed_files }}"
        scenes_changed: "{{ 'scenes.yaml' in changed_files }}"
    # Reload automations if changed
    - if:
        - condition: template
          value_template: "{{ automations_changed }}"
      then:
        - service: automation.reload
    # Reload scripts if changed
    - if:
        - condition: template
          value_template: "{{ scripts_changed }}"
      then:
        - service: script.reload
    # Reload scenes if changed
    - if:
        - condition: template
          value_template: "{{ scenes_changed }}"
      then:
        - service: scene.reload
    # Restart Z2M addon if its config changed
    - if:
        - condition: template
          value_template: "{{ z2m_changed }}"
      then:
        - service: hassio.addon_restart
          data:
            addon: 45df7312_zigbee2mqtt
    # Notification with what was reloaded
    - service: persistent_notification.create
      data:
        title: "Git Pull"
        message: >
          Config uppdaterad: {{ now().strftime('%Y-%m-%d %H:%M') }}
          {% if automations_changed %}✓ Automations{% endif %}
          {% if scripts_changed %}✓ Scripts{% endif %}
          {% if scenes_changed %}✓ Scenes{% endif %}
          {% if z2m_changed %}✓ Zigbee2MQTT{% endif %}
          {% if not (automations_changed or scripts_changed or scenes_changed or z2m_changed) %}(inga reloads behövdes){% endif %}
        notification_id: git_pull_status
  mode: single

- id: git_pull_on_startup
  alias: "Git - Pull vid uppstart"
  description: "Hämtar senaste config från GitHub när HA startar"
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay:
        seconds: 30
    - service: shell_command.git_pull
    - service: persistent_notification.create
      data:
        title: "Uppstart Git Pull"
        message: "Config synkad från GitHub vid uppstart: {{ now().strftime('%Y-%m-%d %H:%M') }}"
        notification_id: git_pull_startup
  mode: single

- id: git_pull_scheduled
  alias: "Git - Schemalagd pull"
  description: "Backup: hämtar config från GitHub var 6:e timme"
  trigger:
    - platform: time_pattern
      hours: "/6"
  action:
    - service: shell_command.git_pull
  mode: single

- id: claude_snapshot_on_demand
  alias: "Claude - Generate Snapshot"
  description: "Generates a live HA snapshot for Claude Desktop when button is pressed"
  trigger:
    - platform: event
      event_type: call_service
      event_data:
        domain: input_button
        service: press
        service_data:
          entity_id: input_button.generate_claude_snapshot
  action:
    - service: script.generate_claude_snapshot
  mode: single
