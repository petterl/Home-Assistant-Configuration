# =============================================================================
# TEMPLATE SENSORS - ELECTRICITY PRICING AND DEMAND TARIFF
# =============================================================================
# Pricing (Skellefteå Kraft):
#   - Spot price SE3 + 0.06 SEK/kWh markup + 0.006 SEK/kWh electricity certificate
#   - Monthly fee: 39.20 SEK
# Demand tariff (grid):
#   - Summer (Apr-Oct): 22 SEK/kW
#   - Winter (Nov-Mar): 43 SEK/kW
#   - Based on average of 5 highest hourly peak demands per month
# =============================================================================

- sensor:
    - name: "Elpris Skellefteå Kraft"
      unique_id: elpris_skelleftea_kraft
      unit_of_measurement: "SEK/kWh"
      device_class: monetary
      state: >
        {% set spot = states('sensor.nordpool_kwh_se3_sek_3_10_025') | float(0) %}
        {% set markup = 0.066 %}
        {{ (spot + markup) | round(4) }}
      attributes:
        spot_price: "{{ states('sensor.nordpool_kwh_se3_sek_3_10_025') }}"
        markup: "0.06 SEK/kWh"
        electricity_certificate: "0.006 SEK/kWh"
        monthly_fee: "39.20 SEK/month"

    - name: "Ersättning Solproduktion"
      unique_id: ersattning_solproduktion
      unit_of_measurement: "SEK/kWh"
      device_class: monetary
      state: >
        {% set spot = states('sensor.nordpool_kwh_se3_sek_3_10_025') | float(0) %}
        {% set bonus = 0.02 %}
        {{ (spot + bonus) | round(4) }}
      attributes:
        spot_price: "{{ states('sensor.nordpool_kwh_se3_sek_3_10_025') }}"
        production_bonus: "0.02 SEK/kWh"

    - name: "Effektavgift Månad"
      unique_id: effektavgift_manad
      unit_of_measurement: "SEK"
      device_class: monetary
      state: >
        {% set peak_kw = states('sensor.peak_power_top_5_average') | float(0) %}
        {% set month = now().month %}
        {% if month >= 4 and month <= 10 %}
          {% set rate = 22 %}
        {% else %}
          {% set rate = 43 %}
        {% endif %}
        {{ (peak_kw * rate) | round(2) }}
      attributes:
        peak_power_kw: "{{ states('sensor.peak_power_top_5_average') }}"
        season: "{{ 'summer' if now().month >= 4 and now().month <= 10 else 'winter' }}"
        rate_kr_per_kw: "{{ 22 if now().month >= 4 and now().month <= 10 else 43 }}"
        summer_rate: "22 kr/kW"
        winter_rate: "43 kr/kW"
        calculation_method: "Average of top 5 hourly peaks"

    # Dashboard display sensors
    - name: "Elpris Lägsta Idag"
      unique_id: elpris_lagsta_idag
      unit_of_measurement: "kr"
      icon: mdi:arrow-down
      state: >
        {{ state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'min') | round(2) }}

    - name: "Elpris Högsta Idag"
      unique_id: elpris_hogsta_idag
      unit_of_measurement: "kr"
      icon: mdi:arrow-up
      state: >
        {{ state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'max') | round(2) }}

    - name: "Elpris Medel Idag"
      unique_id: elpris_medel_idag
      unit_of_measurement: "kr"
      icon: mdi:arrow-left-right
      state: >
        {{ state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'average') | round(2) }}

    # =========================================================================
    # PEAK POWER SENSORS (parsed from single SQL JSON query)
    # These provide backwards-compatible entity IDs from sensor.peak_power_data
    # =========================================================================
    - name: "Peak Power Top 5 Average"
      unique_id: peak_power_top_5_average
      unit_of_measurement: "kW"
      device_class: power
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set json = data | from_json %}
          {{ json.top5_avg_kw | default(0) }}
        {% else %}0{% endif %}

    - name: "Peak Power 5th Highest"
      unique_id: peak_power_5th_highest
      unit_of_measurement: "kW"
      device_class: power
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set json = data | from_json %}
          {% set peaks = json.peaks | default([]) %}
          {% if peaks | length >= 5 %}
            {{ peaks[4].value_kw }}
          {% else %}0{% endif %}
        {% else %}0{% endif %}

    - name: "Peak Power 1 Time"
      unique_id: peak_power_1_time
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[0].time if peaks | length > 0 else 'unknown' }}
        {% else %}unknown{% endif %}

    - name: "Peak Power 1 Value"
      unique_id: peak_power_1_value
      unit_of_measurement: "W"
      device_class: power
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[0].value_w if peaks | length > 0 else 0 }}
        {% else %}0{% endif %}

    - name: "Peak Power 2 Time"
      unique_id: peak_power_2_time
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[1].time if peaks | length > 1 else 'unknown' }}
        {% else %}unknown{% endif %}

    - name: "Peak Power 2 Value"
      unique_id: peak_power_2_value
      unit_of_measurement: "W"
      device_class: power
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[1].value_w if peaks | length > 1 else 0 }}
        {% else %}0{% endif %}

    - name: "Peak Power 3 Time"
      unique_id: peak_power_3_time
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[2].time if peaks | length > 2 else 'unknown' }}
        {% else %}unknown{% endif %}

    - name: "Peak Power 3 Value"
      unique_id: peak_power_3_value
      unit_of_measurement: "W"
      device_class: power
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[2].value_w if peaks | length > 2 else 0 }}
        {% else %}0{% endif %}

    - name: "Peak Power 4 Time"
      unique_id: peak_power_4_time
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[3].time if peaks | length > 3 else 'unknown' }}
        {% else %}unknown{% endif %}

    - name: "Peak Power 4 Value"
      unique_id: peak_power_4_value
      unit_of_measurement: "W"
      device_class: power
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[3].value_w if peaks | length > 3 else 0 }}
        {% else %}0{% endif %}

    - name: "Peak Power 5 Time"
      unique_id: peak_power_5_time
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[4].time if peaks | length > 4 else 'unknown' }}
        {% else %}unknown{% endif %}

    - name: "Peak Power 5 Value"
      unique_id: peak_power_5_value
      unit_of_measurement: "W"
      device_class: power
      state: >
        {% set data = states('sensor.peak_power_data') %}
        {% if data not in ['unknown', 'unavailable'] %}
          {% set peaks = (data | from_json).peaks | default([]) %}
          {{ peaks[4].value_w if peaks | length > 4 else 0 }}
        {% else %}0{% endif %}

    # Peak power display sensors (value + datetime)
    - name: "Effekttopp 1"
      unique_id: effekttopp_1
      icon: mdi:flash
      state: >
        {% set t = states('sensor.peak_power_1_time') %}
        {% set v = states('sensor.peak_power_1_value') | float(0) %}
        {% if t not in ['unknown', 'unavailable'] %}
        {{ as_timestamp(t) | timestamp_custom('%d/%m %H:00') }} — {{ (v / 1000) | round(2) }} kW
        {% else %}-{% endif %}

    - name: "Effekttopp 2"
      unique_id: effekttopp_2
      icon: mdi:flash
      state: >
        {% set t = states('sensor.peak_power_2_time') %}
        {% set v = states('sensor.peak_power_2_value') | float(0) %}
        {% if t not in ['unknown', 'unavailable'] %}
        {{ as_timestamp(t) | timestamp_custom('%d/%m %H:00') }} — {{ (v / 1000) | round(2) }} kW
        {% else %}-{% endif %}

    - name: "Effekttopp 3"
      unique_id: effekttopp_3
      icon: mdi:flash
      state: >
        {% set t = states('sensor.peak_power_3_time') %}
        {% set v = states('sensor.peak_power_3_value') | float(0) %}
        {% if t not in ['unknown', 'unavailable'] %}
        {{ as_timestamp(t) | timestamp_custom('%d/%m %H:00') }} — {{ (v / 1000) | round(2) }} kW
        {% else %}-{% endif %}

    - name: "Effekttopp 4"
      unique_id: effekttopp_4
      icon: mdi:flash
      state: >
        {% set t = states('sensor.peak_power_4_time') %}
        {% set v = states('sensor.peak_power_4_value') | float(0) %}
        {% if t not in ['unknown', 'unavailable'] %}
        {{ as_timestamp(t) | timestamp_custom('%d/%m %H:00') }} — {{ (v / 1000) | round(2) }} kW
        {% else %}-{% endif %}

    - name: "Effekttopp 5"
      unique_id: effekttopp_5
      icon: mdi:flash
      state: >
        {% set t = states('sensor.peak_power_5_time') %}
        {% set v = states('sensor.peak_power_5_value') | float(0) %}
        {% if t not in ['unknown', 'unavailable'] %}
        {{ as_timestamp(t) | timestamp_custom('%d/%m %H:00') }} — {{ (v / 1000) | round(2) }} kW
        {% else %}-{% endif %}

    # Unknown energy consumption (total - tracked devices)
    - name: "Okänd Energi 24h"
      unique_id: okand_energi_24h
      icon: mdi:help-circle
      unit_of_measurement: "kWh"
      state_class: measurement
      state: >
        {% set total = states('sensor.total_energi_24h_wh') | float(0) / 1000 %}
        {% set ftx = states('sensor.ftx_energi_24h') | float(0) %}
        {% set casa = states('sensor.casa_energi_24h') | float(0) %}
        {% set frys = states('sensor.frys_energi_24h') | float(0) %}
        {% set tork = states('sensor.torktumlare_energi_24h') | float(0) %}
        {% set unknown = total - ftx - casa - frys - tork %}
        {{ unknown | round(1) }}

    # Unknown power (for chart)
    - name: "Okänd Effekt"
      unique_id: okand_effekt
      icon: mdi:help-circle
      unit_of_measurement: "W"
      state_class: measurement
      state: >
        {% set total = states('sensor.smart_meter_ts_65a_3_aktiv_effekt') | float(0) %}
        {% set ftx = states('sensor.ftx_power') | float(0) %}
        {% set casa = states('sensor.casa_power') | float(0) %}
        {% set frys = states('sensor.frys_power') | float(0) %}
        {% set tork = states('sensor.torktumlare_effekt') | float(0) %}
        {% set unknown = total - ftx - casa - frys - tork %}
        {{ [unknown, 0] | max | round(0) }}

# =============================================================================
# BINARY SENSORS - DEVICE RUNNING STATE (for history_stats)
# =============================================================================
- binary_sensor:
    - name: "FTX Aktiv"
      unique_id: ftx_aktiv
      device_class: running
      state: "{{ states('sensor.ftx_power') | float(0) > 5 }}"

    - name: "CASA Aktiv"
      unique_id: casa_aktiv
      device_class: running
      state: "{{ states('sensor.casa_power') | float(0) > 5 }}"

    - name: "Frys Kompressor"
      unique_id: frys_kompressor
      device_class: running
      state: "{{ states('sensor.frys_power') | float(0) > 10 }}"

    - name: "Disk Low"
      unique_id: disk_low
      device_class: problem
      state: "{{ states('sensor.system_monitor_disk_use_config') | float(0) > 85 }}"

    - name: "Memory High"
      unique_id: memory_high
      device_class: problem
      state: "{{ states('sensor.system_monitor_memory_use_percent') | float(0) > 90 }}"

    - name: "Vatten Rinner"
      unique_id: vatten_rinner
      device_class: moisture
      icon: mdi:water-alert
      state: "{{ states('sensor.water_meter_t_display_current_water_flow') | float(0) > 1 }}"

    # Solar export price threshold - used by solar export automations
    # ON = price is below threshold (should limit export)
    # OFF = price is at or above threshold (normal export)
    - name: "Export Pris För Lågt"
      unique_id: export_pris_for_lagt
      icon: mdi:currency-usd-off
      state: >
        {% set price = states('sensor.nordpool_kwh_se3_sek_3_10_025') | float(none) %}
        {% set threshold = states('input_number.export_begransning_pris') | float(0) %}
        {{ price is not none and price < threshold }}

# =============================================================================
# WATER COST SENSORS
# =============================================================================
- sensor:
    - name: "Vattenkostnad Total"
      unique_id: vattenkostnad_total
      unit_of_measurement: "SEK"
      device_class: monetary
      icon: mdi:water
      state: >
        {% set consumption = states('sensor.water_meter_t_display_total_water_consumption') | float(0) %}
        {% set price = 23.50 %}
        {{ (consumption * price) | round(0) }}
      attributes:
        consumption_m3: "{{ states('sensor.water_meter_t_display_total_water_consumption') }}"
        price_per_m3: "23.50"
        note: "Tekniska verken Linköping - justera pris i secrets.yaml"

    - name: "Vattenkostnad Månad"
      unique_id: vattenkostnad_manad
      unit_of_measurement: "SEK"
      device_class: monetary
      icon: mdi:water
      state: >
        {% set consumption = states('sensor.vatten_manad') | float(0) %}
        {% set price = 23.50 %}
        {{ (consumption * price) | round(0) }}

    - name: "Vattenkostnad År"
      unique_id: vattenkostnad_ar
      unit_of_measurement: "SEK"
      device_class: monetary
      icon: mdi:water
      state: >
        {% set consumption = states('sensor.vatten_ar') | float(0) %}
        {% set price = 23.50 %}
        {{ (consumption * price) | round(0) }}

# =============================================================================
# TRIGGER-BASED TEMPLATE SENSORS
# =============================================================================
# These sensors update on specific triggers and compute once, storing results
# in attributes. More efficient than recalculating on every state read.
#
# OPTIMIZATION: Sorted prices computed once and stored as JSON, then parsed
# by simple template sensors for each hour slot.
# =============================================================================

- trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: sensor.nordpool_kwh_se3_sek_3_10_025
    - platform: time_pattern
      hours: "*"  # Update every hour to refresh "remaining today" hours
  sensor:
    - name: "Billigaste Timpriser Data"
      unique_id: billigaste_timpriser_data
      icon: mdi:lightning-bolt
      state: >
        {% set today = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'today') or [] %}
        {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'tomorrow') or [] %}
        {% set step = 4 if today | length > 24 else 1 %}
        {% set ns = namespace(prices=[]) %}
        {% for i in range(0, today | length, step) %}
          {% set hour = (i / step) | int %}
          {% if hour >= now().hour %}
            {% set ns.prices = ns.prices + [{'price': today[i], 'day': 'Idag', 'hour': hour}] %}
          {% endif %}
        {% endfor %}
        {% for i in range(0, tomorrow | length, step) %}
          {% set hour = (i / step) | int %}
          {% set ns.prices = ns.prices + [{'price': tomorrow[i], 'day': 'Imorgon', 'hour': hour}] %}
        {% endfor %}
        {% set sorted = ns.prices | sort(attribute='price') %}
        {{ sorted | length }} timmar
      attributes:
        # Store sorted prices as JSON - computed once, used by display sensors
        sorted_prices: >
          {% set today = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'today') or [] %}
          {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'tomorrow') or [] %}
          {% set step = 4 if today | length > 24 else 1 %}
          {% set ns = namespace(prices=[]) %}
          {% for i in range(0, today | length, step) %}
            {% set hour = (i / step) | int %}
            {% if hour >= now().hour %}
              {% set ns.prices = ns.prices + [{'price': today[i], 'day': 'Idag', 'hour': hour}] %}
            {% endif %}
          {% endfor %}
          {% for i in range(0, tomorrow | length, step) %}
            {% set hour = (i / step) | int %}
            {% set ns.prices = ns.prices + [{'price': tomorrow[i], 'day': 'Imorgon', 'hour': hour}] %}
          {% endfor %}
          {{ ns.prices | sort(attribute='price') | to_json }}

# Display sensors that read from the pre-computed sorted prices
- sensor:
    - name: "Billigaste Timpriser"
      unique_id: billigaste_timpriser
      icon: mdi:lightning-bolt
      state: >
        {% set prices = state_attr('sensor.billigaste_timpriser_data', 'sorted_prices') | default('[]') | from_json %}
        {% if prices | length > 0 %}
          {% set p = prices[0] %}
          {{ p.day }} {{ '%02d:00' | format(p.hour) }} — {{ p.price | round(2) }} kr
        {% else %}-{% endif %}
      attributes:
        hour_1: >
          {% set prices = state_attr('sensor.billigaste_timpriser_data', 'sorted_prices') | default('[]') | from_json %}
          {% if prices | length > 0 %}{% set p = prices[0] %}{{ p.day }} {{ '%02d:00' | format(p.hour) }} — {{ p.price | round(2) }} kr{% else %}-{% endif %}
        hour_2: >
          {% set prices = state_attr('sensor.billigaste_timpriser_data', 'sorted_prices') | default('[]') | from_json %}
          {% if prices | length > 1 %}{% set p = prices[1] %}{{ p.day }} {{ '%02d:00' | format(p.hour) }} — {{ p.price | round(2) }} kr{% else %}-{% endif %}
        hour_3: >
          {% set prices = state_attr('sensor.billigaste_timpriser_data', 'sorted_prices') | default('[]') | from_json %}
          {% if prices | length > 2 %}{% set p = prices[2] %}{{ p.day }} {{ '%02d:00' | format(p.hour) }} — {{ p.price | round(2) }} kr{% else %}-{% endif %}
        hour_4: >
          {% set prices = state_attr('sensor.billigaste_timpriser_data', 'sorted_prices') | default('[]') | from_json %}
          {% if prices | length > 3 %}{% set p = prices[3] %}{{ p.day }} {{ '%02d:00' | format(p.hour) }} — {{ p.price | round(2) }} kr{% else %}-{% endif %}
        hour_5: >
          {% set prices = state_attr('sensor.billigaste_timpriser_data', 'sorted_prices') | default('[]') | from_json %}
          {% if prices | length > 4 %}{% set p = prices[4] %}{{ p.day }} {{ '%02d:00' | format(p.hour) }} — {{ p.price | round(2) }} kr{% else %}-{% endif %}

